/*!
 * OpenUI5
 * (c) Copyright 2026 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Lib","sap/ui/model/json/JSONModel","sap/m/p13n/QueryPanel","sap/m/IconTabFilter","sap/ui/core/Icon","sap/ui/model/Sorter","sap/m/OverflowToolbar","sap/m/ToolbarSpacer","sap/m/Title","sap/m/Label","sap/m/HBox","sap/m/VBox","sap/ui/model/Filter","sap/ui/core/ListItem","sap/m/ComboBox","sap/m/List","sap/m/CustomListItem","sap/m/GroupHeaderListItem","sap/ui/layout/Grid","sap/ui/layout/GridData","sap/m/SegmentedButton","sap/m/SegmentedButtonItem","sap/ui/core/library","sap/m/table/Util","sap/ui/core/CustomData","sap/m/Button","sap/m/ToggleButton","sap/ui/core/InvisibleText","sap/ui/Device","sap/ui/layout/VerticalLayout"],(t,e,i,o,s,n,r,a,l,p,d,c,h,u,_,g,y,m,f,E,P,L,C,S,T,M,F,I,b,O)=>{"use strict";const{ValueState:R}=C;const D=i.extend("sap.ui.mdc.p13n.panels.AdaptFiltersPanelContent",{metadata:{library:"sap.ui.mdc",properties:{itemFactory:{type:"function"},defaultView:{type:"string",defaultValue:"list"}}},renderer:{apiVersion:2}});D.prototype.GROUP_KEY="group";D.prototype.CHANGE_REASON_FILTER="Filter";D.prototype.CHANGE_REASON_SHOW="Show";D.prototype.CHANGE_REASON_HIDE="Hide";D.prototype.LIST_KEY="list";D.prototype.PRESENCE_ATTRIBUTE="visible";D.prototype.CONTROL_MODEL="$sap.ui.mdc.p13n";D.prototype.applySettings=function(t){i.prototype.applySettings.apply(this,arguments);const o=this.getDefaultView();this._oViewModel=new e({editable:true,grouped:o===this.GROUP_KEY,selectedKey:o});this.setModel(this._oViewModel,this.CONTROL_MODEL)};D.prototype.setP13nData=function(t){t=this._enhanceP13nData(t);this._getP13nModel().setProperty("/items",t);this._bindList();this._updateAddFilterVisibility();return this};D.prototype.restoreDefaults=function(){this._oViewModel.setProperty("/grouped",false);this._oViewModel.setProperty("/editable",true);this._updateFilterFieldsEditMode("edit");this._oModeButton.setSelectedKey("edit");this._oCurrentViewKey=this.LIST_KEY;this._bindList();this._getSearchField().setValue("");this._filterByModeAndSearch()};D.prototype.setP13nModel=function(t){this.setModel(t,this.P13N_MODEL);this.setP13nData(t.getData());this._filterByModeAndSearch()};D.prototype.getP13nModel=function(){return this.getModel(this.P13N_MODEL)};D.prototype.addCustomView=function(t){const{item:e}=t;const i=e.getKey();if(!i){throw new Error("Please provide an item of type sap.m.SegmentedButtonItem with a key")}this._oPanelHeader.addItem(new o({key:i,text:e.getText()}));this.getAggregation("_content").addItem(new c({items:[t.content],visible:false,customData:new T({key:"customView",value:i})}))};D.prototype.getSelectedFields=function(){return this._getP13nModel().getProperty("/items").filter(t=>t[this.PRESENCE_ATTRIBUTE]&&t.visibleInDialog).map(t=>t.name)};D.prototype._enhanceP13nData=function(t){const e=t.filter(t=>t.isFiltered&&!t.visible).slice();e.forEach(t=>{const e=this._getP13nModel().getProperty("/items").find(e=>e.name===t.name);if(!e||e.position==-1){return}t.position=e.position;t.oldPosition=e.position});this._sortItems(e);this._sortItems(t);for(const i of e){if(i.oldPosition===-1){break}for(let e=i.oldPosition;e<t.length;e++){if(t[e].name==i.name){t[e].position=i.oldPosition;continue}if(t[e]&&t[e].position!==-1){t[e].position++}}delete i.oldPosition;this._sortItems(t)}return t};D.prototype._setInnerLayout=function(){const t=new O({width:"100%",content:[this._oListControl,this._getAddFilterSection()]});this.setAggregation("_content",t)};D.prototype._createInnerListControl=function(){const t=this._getDragDropConfig();t.bindProperty("enabled",{parts:[`${this.CONTROL_MODEL}>/editable`,`${this.CONTROL_MODEL}>/grouped`],formatter:(t,e)=>!t&&!e});t.setKeyboardHandling(true);const e=new g(this.getId()+"-innerP13nList",{ariaLabelledBy:this.getId()+"-title",dragDropConfig:t,keyboardMode:"Edit",headerToolbar:this._getToolbar(),selectionChange:this._onSelectionChange.bind(this)});return e};D.prototype._getToolbar=function(){if(!this._oToolbar){this._oToolbar=new r({content:[new l(this.getId()+"-title",{text:this._getResourceText("adaptFiltersPanel.TOOLBAR_TITLE")}),new a,this._getSearchField(),this._getModeButton()]})}return this._oToolbar};D.prototype._getModeButton=function(){if(!this._oModeButton){this._oModeButton=new P({visible:`{=%{${this.CONTROL_MODEL}>/grouped} === false}`,selectedKey:"edit",items:[new L({key:"edit",text:this._getResourceText("adaptFiltersPanel.VIEW_MODE_EDIT")}),new L({key:"sort",text:this._getResourceText("adaptFiltersPanel.VIEW_MODE_SORT")})],selectionChange:this._onModeChange.bind(this)})}return this._oModeButton};D.prototype._onModeChange=function(t){const e=t.getParameter("item");const i=e.getKey();this._updateFilterFieldsEditMode(i);const o=i==="edit";this._oViewModel.setProperty("/editable",o);this._oListControl.setKeyboardMode(o?"Edit":"Navigation")};D.prototype._updateFilterFieldsEditMode=function(t){const e=this._oListControl.getItems();e.forEach(e=>{if(e.isA("sap.m.CustomListItem")){if(t==="sort"){e.getContent()[0].getContent()[1].getItems()[0].setEditMode("Disabled")}if(t==="edit"){e.getContent()[0].getContent()[1].getItems()[0].setEditMode("Editable")}}})};D.prototype._getAddFilterSection=function(){if(!this._oAddFilterSelect){this._oKeySelect=this._createKeySelect().setLayoutData(new E({span:"XL5 L5 M5 S12"}));const t=new p({text:this._getResourceText("adaptFiltersPanel.ADD_FILTER_LABEL"),showColon:true,labelFor:this._oKeySelect,vAlign:"Middle",width:"100%",wrapping:true}).setLayoutData(new E({span:"XL2 L2 M2 S12"})).addStyleClass("sapUiMDCAdaptFiltersPanelFilterLabel");this._oAddFilterSelect=new f({containerQuery:true,width:"100%",hSpacing:.5,content:[t,this._oKeySelect]}).addStyleClass("sapUiMDCAdaptFiltersPanelAddFilterSection")}return this._oAddFilterSelect};D.prototype._createKeySelect=function(){const t=new _({width:"100%",placeholder:this._getPlaceholderText(),change:t=>{const e=t.getSource();const i=t.getParameter("newValue");e.setValueState(i&&!e.getSelectedItem()?R.Error:R.None);this._selectKey(e);setTimeout(()=>e.clearSelection(),100)}});return t};D.prototype._updateAddFilterVisibility=function(){const t=this._getP13nModel().getProperty("/items").some(t=>!t[this.PRESENCE_ATTRIBUTE]&&!t.required);this._oAddFilterSelect.setVisible(t);const e=this._oViewModel.getProperty("/grouped");this._oKeySelect.bindItems(this._getKeySelectBindingInfos(e))};D.prototype._getKeySelectBindingInfos=function(t){const e={path:`${this.P13N_MODEL}>/items`,filters:[new h(this.PRESENCE_ATTRIBUTE,"EQ",false),new h("required","NE",true)],template:new u({key:{path:`${this.P13N_MODEL}>name`},text:{path:`${this.P13N_MODEL}>label`}})};if(t){e.sorter=new n({path:"group",descending:false,group:this._getGroup.bind(this)})}else{e.sorter=new n("label",false)}return e};D.prototype._bindList=function(){const t={path:`${this.P13N_MODEL}>/items`,factory:this._getItemFactory.bind(this),templateShareable:false};const e=this._oViewModel.getProperty("/grouped");if(e){t.sorter=new n({path:"group",descending:false,group:this._getGroup.bind(this)});t.groupHeaderFactory=this._groupHeaderFactory.bind(this)}else{t.sorter=new n({path:"position",descending:false,comparator:(t,e)=>{if(t===e){return 0}if(t===-1){return 1}if(e===-1){return-1}return t-e}})}this._oListControl.removeAllItems();this._oListControl.bindItems(t)};D.prototype._getGroup=function(t){return{key:t.getProperty("group"),text:t.getProperty("groupLabel")||this._getResourceText("adaptFiltersPanel.GROUP_DEFAULT")}};D.prototype._groupHeaderFactory=function(t){return new m({title:t.text,visible:{path:`${this.P13N_MODEL}>/items`,formatter:e=>e.some(e=>{const i=e.group===t.key;const o=e.visibleInDialog===true;const s=e[this.PRESENCE_ATTRIBUTE]||e.isFiltered||e.position>=0;return i&&o&&s})}})};D.prototype._getItemFactory=function(t,e){const i=this._createItemGrid(e);const o=new y({content:i,selected:{path:`${this.P13N_MODEL}>${this.PRESENCE_ATTRIBUTE}`},visible:{parts:[`${this.P13N_MODEL}>${this.PRESENCE_ATTRIBUTE}`,`${this.P13N_MODEL}>isFiltered`,`${this.P13N_MODEL}>position`,`${this.P13N_MODEL}>visibleInDialog`],formatter:(t,e,i,o)=>o&&(t||e||i>=0)}});const s=b.os.macintosh;const n=new I({id:o.getId()+"-reorderingInfo",text:{parts:[`${this.CONTROL_MODEL}>/editable`],formatter:t=>{if(!t){return s?this._getResourceText("adaptFiltersPanel.REORDERING_SHORTCUT_MAC"):this._getResourceText("adaptFiltersPanel.REORDERING_SHORTCUT_WINDOWS")}return""}}});o.addAriaLabelledBy(n);o.addContent(n);return o};D.prototype._createFilterLabel=function(t){return new p({text:{path:`${this.P13N_MODEL}>label`},required:{path:`${this.P13N_MODEL}>required`},showColon:true,wrapping:true,width:"100%",wrappingType:"Hyphenated",vAlign:"Middle"}).addStyleClass("sapUiMDCAdaptFiltersPanelFilterLabel")};D.prototype._createFilterControl=function(t){const e=this.getItemFactory().call(this,t);let i=e;if(i.isA("sap.ui.mdc.filterbar.p13n.FilterGroupLayout")){[i]=e.getItems()}if(i.isA("sap.ui.mdc.FilterField")){i.detachChange(this._onFieldChange,this);i.attachChange(this._onFieldChange,this)}e.setLayoutData(new E({span:"XL8 L8 M8 S8"}));const o=e.clone();if(o.isA("sap.ui.mdc.filterbar.p13n.FilterGroupLayout")){o.setFilterField(i)}return o};D.prototype._onFieldChange=function(t){const e=t.getSource();const i=e.getPropertyKey();const o=this.getP13nData().find(t=>t.name===i);const s=e.getConditions().length>0;this._updateFilteredState(i,s);if(o.required){const t=this._oListControl.getItems();const e=t.find(t=>t.getBindingContext(this.P13N_MODEL)?.getObject().key===o.key);const[n]=e.getContent()[0].getContent()[2].getContent();this._updateFilteredState(i,s);n.setEnabled(s);if(!s&&!o.visible){n.setPressed(true);this._updatePresence(i,true)}}this.fireChange({reason:this.CHANGE_REASON_FILTER,item:o})};D.prototype._createItemGrid=function(t){const e=t.getObject();const i=this._createFilterLabel(e);const o=this._createFilterControl(t);o.addAriaLabelledBy?.(i);i.setLabelFor(o);const s=this._createDeleteAction();const n=this._createSortAction();const r=this._createVisibilityAction(t);const a=new f({containerQuery:true,hSpacing:.25,defaultSpan:"XL6 L6 M6 S6",content:[r,s,n]}).setLayoutData(new E({span:"XL2 L2 M2 S4"}));i.setLayoutData(new E({span:"XL2 L2 M2 S12"}));o.setLayoutData(new E({span:"XL8 L8 M8 S8",linebreakS:true}));return new f({containerQuery:true,hSpacing:.5,defaultSpan:"XL3 L3 M3 S12",content:[i,o,a]})};D.prototype._createDeleteAction=function(){return new M({icon:"sap-icon://decline",type:"Transparent",tooltip:this._getResourceText("adaptFiltersPanel.ACTION_DELETE"),visible:{parts:[`${this.P13N_MODEL}>${this.PRESENCE_ATTRIBUTE}`,`${this.P13N_MODEL}>required`,`${this.CONTROL_MODEL}>/editable`,`${this.P13N_MODEL}>position`],formatter:(t,e,i,o)=>!e&&i},press:t=>{const e=t.getSource();const i=this._getListItemFromControl(e);this._onRemoveRow(i);this._updateAddFilterVisibility()}})};D.prototype._createSortAction=function(){return new s({src:"sap-icon://horizontal-grip",tooltip:this._getResourceText("adaptFiltersPanel.ACTION_SORT"),useIconTooltip:true,color:"#000",visible:{parts:[`${this.CONTROL_MODEL}>/editable`,`${this.CONTROL_MODEL}>/grouped`],formatter:(t,e)=>!t&&!e}}).addStyleClass("sapUiMDCAdaptFiltersContentSortIcon")};D.prototype._createVisibilityAction=function(t){const e=this._getFilterFieldFromItem(t);const i=t.getObject();const o=new F({enabled:i.required?e.getConditions().length!=0:true,pressed:i.visible,icon:{path:`${this.P13N_MODEL}>${this.PRESENCE_ATTRIBUTE}`,formatter:t=>t?"sap-icon://show":"sap-icon://hide"},tooltip:{path:`${this.P13N_MODEL}>${this.PRESENCE_ATTRIBUTE}`,formatter:t=>t?this._getResourceText("adaptFiltersPanel.ACTION_VISIBILITY_SHOW"):this._getResourceText("adaptFiltersPanel.ACTION_VISIBILITY_HIDE")},press:t=>{const e=t.getSource();const i=this._getListItemFromControl(e);const o=i.getBindingContext(this.P13N_MODEL).getProperty("name");const s=this.getP13nData().find(t=>t.name===o);s.visible=!i.getBindingContext(this.P13N_MODEL).getProperty(this.PRESENCE_ATTRIBUTE);const n=i.getBindingContext(this.P13N_MODEL).getProperty(this.PRESENCE_ATTRIBUTE);this._updatePresence(o,!n);this.fireChange({reason:!n?this.CHANGE_REASON_SHOW:this.CHANGE_REASON_HIDE,item:s})}});return o};D.prototype._getListItemFromControl=function(t){let e=t.getParent();while(e&&!e.isA("sap.m.ListItemBase")){e=e.getParent()}return e};D.prototype._sortItems=function(t){t.sort((t,e)=>{if(t.position===-1){return 1}if(e.position===-1){return-1}return t.position-e.position})};D.prototype._getControlFromRow=function(t,e){if(!t){return null}if(t.isA("sap.m.GroupHeaderListItem")){return t}if(t?.getContent()[0].getContent){return i.prototype._getControlFromRow.call(this,t,e)}const o=t.getContent()[0].getItems()[1].getContent();e??=0;e=e<0?o.length+e:e;return o[e]};D.prototype._onRearrange=function(t){const e=t.getParameter("draggedControl");const i=t.getParameter("droppedControl");const o=t.getParameter("dropPosition");const s=this._getModelEntry(e).position;const n=this._getModelEntry(i).position;const r=n+(o=="Before"?0:1)+(s<n?0:1);this._moveListItem(e,r)};D.prototype._onListActionPress=function(t){const e=t.getParameter("action");if(e.getType()==="Delete"){this._onRemoveRow(t.getParameter("listItem"));this._updateAddFilterVisibility()}};D.prototype._onRemoveRow=function(t){const e=t.getBindingContext(this.P13N_MODEL).getProperty("name");const i=t.getBindingContext(this.P13N_MODEL);this._updateFocus(t);this._removeFilteredState(e,i);this._updatePresence(e,false);this._updatePosition(e,false);const o=this.getP13nData().find(t=>t.name===e);this.fireChange({reason:this.CHANGE_REASON_REMOVE,item:o});const s=this._getP13nModel().getProperty("/items");this._sortItems(s);this._getP13nModel().setProperty("/items",s);this._getP13nModel().checkUpdate(true)};D.prototype._updateFocus=function(t){const e=this._oListControl.getItems().filter(t=>t.getVisible()).indexOf(t);const i=()=>{const t=this._oListControl.getItems().filter(t=>t.getVisible());if(e>=0&&e<t.length){t[e].focus()}else{t[t.length-1].focus()}};this._oListControl.attachEventOnce("updateFinished",i)};D.prototype._moveListItem=function(t,e){const i=this._getModelEntry(t);const o=this._getP13nModel().getProperty("/items");this._sortItems(o);o.splice(o.indexOf(i),1);o.splice(e-1,0,i);o[e-1].position=e-1;o.forEach((t,e)=>{if(t.position===-1||!t.position){return}t.position=e});this._getP13nModel().setProperty("/items",o);this._getP13nModel().checkUpdate(true);this.fireChange({reason:this.CHANGE_REASON_REORDER,item:i});setTimeout(()=>{const t=this._oListControl.getItems().filter(t=>t.getVisible());t[e-1].focus()},0)};D.prototype._selectKey=function(t){const e=t.getSelectedKey();if(!e){return}const i=this.getP13nData().find(t=>t.name===e);if(i){this._updatePresence(e,true);this._updatePosition(e,true);const t=this._getP13nModel().getProperty("/items");const o=t.find(t=>t.name===e);let s=-1;t.forEach((t,e)=>{if(t[this.PRESENCE_ATTRIBUTE]&&t.position>=0&&e>s){s=e}});t.splice(t.indexOf(o),1);t.splice(s+1,0,o);this._updateAddFilterVisibility();this._getP13nModel().setProperty("/items",t);this._getP13nModel().checkUpdate(true);this.fireChange({reason:this.CHANGE_REASON_ADD,item:this.getP13nData().find(t=>t.name===e)});const n=this._oListControl.getBinding("items");if(n.getFilters("Control").length>0){n.filter(new h([...n.getFilters("Control"),new h("name","EQ",i.name)],false))}setTimeout(()=>setTimeout(()=>{const t=this._oListControl.getItems();const i=t.find(t=>{const i=t.getBindingContext(this.P13N_MODEL);if(!i){return false}const o=i.getObject();return o&&o.name===e});i?.getContent()[0].getContent()[1].getItems()[0].focus()},0),0)}};D.prototype._updatePresence=function(t,e,i){const o=this._getP13nModel().getProperty("/items");const s=o.findIndex(e=>e.name===t);if(s<0){return}o[s][this.PRESENCE_ATTRIBUTE]=e;this._getP13nModel().setProperty("/items",o)};D.prototype._updatePosition=function(t,e){const i=this._getP13nModel().getProperty("/items");const o=i.find(e=>e.name===t);let s=o.position;if(e&&(o.position===-1||o.position===undefined)){s=i.reduce((t,e)=>e.position>t?e.position:t,-1)+1}else if(!e){s=-1}o.position=s;this._getP13nModel().setProperty("/items",i)};D.prototype._updateVisibleInDialog=function(t,e){const i=this._getP13nModel().getProperty("/items");const o=i.findIndex(e=>e.name===t);if(o<0){return}i[o].visibleInDialog=e;this._getP13nModel().setProperty("/items",i)};D.prototype._updateFilteredState=function(t,e){const i=this._getP13nModel().getProperty("/items");const o=i.find(e=>e.name===t);if(!o){return}o.isFiltered=e;this._getP13nModel().setProperty("/items",i)};D.prototype._removeFilteredState=function(t,e){const i=this._getP13nModel().getProperty("/items");const o=i.findIndex(e=>e.name===t);if(o<0){return}i[o].isFiltered=false;this._getP13nModel().setProperty("/items",i);if(e){const t=this._getFilterFieldFromItem(e);if(t&&t.isA&&t.isA("sap.ui.mdc.FilterField")){t.setConditions([])}}};D.prototype._filterByModeAndSearch=function(){this._sSearchString=this._getSearchField().getValue();const t=this._createFilterQuery();this._getSearchField().setValue(this._sSearchString);const e=this._oListControl?.getBinding("items");if(e){e.filter(t,true)}return t};D.prototype._createFilterQuery=function(){let t=[],e=[],i=[];if(this._sSearchString){t=[new h("label","Contains",this._sSearchString),new h("tooltip","Contains",this._sSearchString)];i=new h(t,false)}switch(this._sModeKey){case"visible":e=new h("visible","EQ",true);break;case"active":e=new h("active","EQ",true);break;case"mandatory":e=new h("required","EQ",true);break;case"visibleactive":e=new h([new h("active","EQ",true),new h("visible","EQ",true)],true);break;default:}const o=new h("visibleInDialog","EQ",true);return new h([].concat(i,e,o),true)};D.prototype._announceSearchUpdate=function(){const t=this._oListControl.getItems().filter(t=>t.getVisible()).length;S.announceTableUpdate(this._getResourceText("adaptFiltersPanel.TOOLBAR_TITLE"),t)};D.prototype._getModelEntry=function(t){const e=t.getBindingContext(this.P13N_MODEL);if(!e){return null}return e.getObject()};D.prototype._getPlaceholderText=function(){return this._getResourceText("adaptFiltersPanel.ADD_FILTER_PLACEHOLDER")};D.prototype._getResourceText=function(e,i){this.oResourceBundle=this.oResourceBundle?this.oResourceBundle:t.getResourceBundleFor("sap.ui.mdc");return e?this.oResourceBundle.getText(e,i):this.oResourceBundle};D.prototype._getFilterFieldFromItem=function(t){if(!this.getItemFactory()||!t){return null}try{const e=this.getItemFactory().call(this,t);if(e&&e._oFilterField){return e._oFilterField}return e}catch(t){return null}};D.prototype._updateMovement=function(t){return this};D.prototype.exit=function(){i.prototype.exit.apply(this,arguments);this._oViewModel?.destroy();this._oListControl?.destroy();this._oPanelHeader?.destroy();this._oAddFilterSelect?.destroy();this._oViewModel=null;this._oListControl=null;this._oPanelHeader=null;this._oAddFilterSelect=null};return D});
//# sourceMappingURL=AdaptFiltersPanelContent.js.map