/*!
 * OpenUI5
 * (c) Copyright 2026 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Element","sap/ui/core/library","sap/ui/mdc/p13n/subcontroller/FilterController","sap/ui/mdc/p13n/subcontroller/AdaptFiltersController","sap/ui/mdc/filterbar/p13n/GroupContainer","sap/ui/mdc/filterbar/p13n/FilterColumnLayout","sap/ui/mdc/filterbar/p13n/FilterGroupLayout","sap/ui/mdc/filterbar/p13n/TableContainer","sap/ui/mdc/filterbar/FilterBarBase","sap/ui/mdc/filterbar/FilterBarBaseRenderer","sap/base/util/merge","sap/m/p13n/enums/PersistenceMode"],(t,e,i,n,o,r,a,s,l,p,h,c)=>{"use strict";const{ValueState:u}=e;const d=l.extend("sap.ui.mdc.filterbar.p13n.AdaptationFilterBar",{metadata:{library:"sap.ui.mdc",properties:{_useFixedWidth:{type:"boolean",defaultValue:false,visibility:"hidden"}},associations:{adaptationControl:{type:"sap.ui.mdc.Control",multiple:false}},events:{change:{}}},renderer:p});d.prototype.WIDTH="30rem";d.prototype.getVerticalScrolling=function(){return this._oFilterBarLayout.getInner().getVerticalScrolling instanceof Function?this._oFilterBarLayout.getInner().getVerticalScrolling():false};d.prototype.init=function(){l.prototype.init.apply(this,arguments);this.addStyleClass("sapUIAdaptationFilterBar");this.getEngine().defaultProviderRegistry.attach(this,c.Transient);this._fnResolveAdaptationControlPromise=null;this._oAdaptationControlPromise=new Promise((t,e)=>{this._fnResolveAdaptationControlPromise=t})};d.prototype.keepAlive=function(){return true};d.prototype._onModifications=function(){const t=l.prototype._onModifications.apply(this,arguments);if(this._oFilterBarLayout.getInner().isA("sap.ui.mdc.p13n.panels.FilterPanel")){const t=this._oFilterBarLayout.getInner().getP13nData();this._updateActiveStatus(t);this._oFilterBarLayout.setP13nData({items:t})}return t};d.prototype.getInitialFocusedControl=function(){return this._oFilterBarLayout.getInitialFocusedControl()};d.prototype.getWidth=function(){return this.WIDTH};d.prototype.applySettings=function(){l.prototype._applySettings.apply(this,arguments);this._waitForAdaptControlAndPropertyHelper().then(()=>{this._initControlDelegate()})};d.prototype.setVisibleFields=function(t){const e=this._getAdaptationControlInstance();if(this._checkAdvancedParent(e)){throw new Error("Only supported for simple parents")}this._aVisibleKeys=t};d.prototype._getPropertyByName=function(t){let e=l.prototype._getPropertyByName.apply(this,arguments);const i=this.getPropertyHelper();if(!e||e.filterable===false){e=i.getProperties().find(e=>e.path===t&&e.filterable)}return e};d.prototype._waitForAdaptControlAndPropertyHelper=function(){return this._oAdaptationControlPromise.then(()=>this._getAdaptationControlInstance().awaitPropertyHelper().then(t=>{this._oPropertyHelper=t}))};d.prototype._initControlDelegate=function(){return this.initControlDelegate().then(()=>{if(!this._bIsBeingDestroyed){this._applyInitialFilterConditions()}})};d.prototype.getControlDelegate=function(){return this._getAdaptationControlInstance().getControlDelegate()};d.prototype.initControlDelegate=function(){return this._oAdaptationControlPromise.then(()=>this._getAdaptationControlInstance().initControlDelegate())};d.prototype.awaitControlDelegate=function(){return this._oAdaptationControlPromise.then(()=>this._getAdaptationControlInstance().awaitControlDelegate())};d.prototype.initPropertyHelper=function(){return this._oAdaptationControlPromise.then(()=>this._getAdaptationControlInstance().initPropertyHelper())};d.prototype.finalizePropertyHelper=function(){return this._oAdaptationControlPromise.then(()=>this._getAdaptationControlInstance().finalizePropertyHelper())};d.prototype.getTypeUtil=function(){return this.getTypeMap()};d.prototype.getTypeMap=function(){if(!this._getAdaptationControlInstance()){throw new Error("No adaptation control assigned yet.")}return this._getAdaptationControlInstance().getTypeMap()};d.prototype.setMessageStrip=function(t){this._oFilterBarLayout.setMessageStrip(t)};d.prototype.setLiveMode=function(t,e){l.prototype.setLiveMode.apply(this,arguments);this._oConditionModel.attachPropertyChange(t=>{const e=t.getParameter("path").substring(12);if(this.oAdaptationData){const t=this.oAdaptationData.items;const i=t.find(t=>t.name==e);if(i&&this._checkAdvancedParent(this._getAdaptationControlInstance())){i.active=this._getConditionModel().getConditions(e).length>0?true:false}}});return this};d.prototype._retrieveMetadata=function(){return this._oAdaptationControlPromise.then(()=>this._getAdaptationControlInstance().awaitPropertyHelper().then(function(t){if(!this._getAdaptationControlInstance().isPropertyHelperFinal()){return this.finalizePropertyHelper()}return l.prototype._retrieveMetadata.apply(this,arguments)}.bind(this)))};d.prototype.isControlDelegateInitialized=function(){return this._getAdaptationControlInstance().isControlDelegateInitialized()};d.prototype.createConditionChanges=function(){return Promise.all([this._oAdaptationControlPromise,this.awaitControlDelegate()]).then(()=>{const t=this._getModelConditions(this._getConditionModel(),false,true);return this.getEngine().createChanges({control:this._getAdaptationControlInstance(),applyAbsolute:true,key:"Filter",state:t,suppressAppliance:true})})};d.prototype.setP13nData=function(t){this.oAdaptationData=t;this._getConditionModel().checkUpdate(true);this._updateActiveStatus(this.oAdaptationData.items);this._oFilterBarLayout.update(t)};d.prototype._updateActiveStatus=function(t){const e=this.getFilterConditions();t.forEach(t=>{const i=this.mFilterFields&&this.mFilterFields[t.name];if(i){const n=i.getPropertyKey();if(e[n]&&e[n].length>0){t.active=true}}})};d.prototype.getP13nData=function(){if(this._aVisibleKeys&&this._aVisibleKeys.length>0){this.oAdaptationData.items.forEach(function(t){if(this._aVisibleKeys.indexOf(t.name)>-1){t.active=true}},this)}return this.oAdaptationData};d.prototype._handleFilterItemSubmit=function(){return};d.prototype._getWaitForChangesPromise=function(){return this.getEngine().waitForChanges(this._getAdaptationControlInstance())};d.prototype.createFilterFields=function(){return this.initializedWithMetadata().then(()=>{const t=this._getAdaptationControlInstance().getFilterConditions();this.setFilterConditions(t);const e=this._setXConditions(t);if(this._bFilterFieldsCreated){return e.then(()=>{this._updateActiveStatus(this.oAdaptationData.items);this._oFilterBarLayout.setP13nData(this.getP13nData());return this})}const i=this._getAdaptationControlInstance();const n=i.getControlDelegate();const o=this._checkAdvancedParent(i)?n:n.getFilterDelegate();this._mOriginalsForClone={};this.mFilterFields={};const r=[];this.getP13nData().items.forEach((t,e)=>{const n=this._checkExisting(t,o);n.then(e=>{let o;if(this._checkAdvancedParent(i)){if(e._bTemporaryOriginal){delete n._bTemporaryOriginal;this._mOriginalsForClone[e.getPropertyKey()]=e}o=e.clone();if(i._handleFilterItemChanges){o.detachChange(i._handleFilterItemChanges,i)}if(i._handleFilterItemSubmit){o.detachSubmit(i._handleFilterItemSubmit,i)}if(o.getValueState()!==u.None){o.setValueState(u.None);o.setValueStateText()}}else{o=e}this.mFilterFields[t.name]=o});r.push(n)});return Promise.all(r).then(()=>{const t=this.getP13nData();t.items.forEach(t=>{this.addAggregation("filterItems",this.mFilterFields[t.name])});this._attachFields();this._updateActiveStatus(t.items);this._oFilterBarLayout.setP13nData(t);this._bFilterFieldsCreated=true;return this})})};d.prototype._attachFields=function(){this.getFilterItems().forEach(t=>{t.attachChange(t=>{this.fireChange()})})};d.prototype._checkExisting=function(t,e){let i;const n=this._getAdaptationControlInstance();const o=this._checkAdvancedParent(n)?n.getFilterItems():[];const r=o.reduce((t,e)=>{t[e.getPropertyKey()]=e;return t},{});if(r[t.name]){i=Promise.resolve(r[t.name])}else{i=e.addItem(this._getAdaptationControlInstance(),t.name);i=i.then(e=>{if(!e){throw new Error("No FilterField could be created for property: '"+t.name+"'.")}e._bTemporaryOriginal=true;return e})}return i};d.prototype.executeRemoves=function(){const t=this._oFilterBarLayout.getInner().getSelectedFields();const e=t.map(t=>t.name);const i=[];Object.keys(this._mOriginalsForClone).forEach(t=>{const n=this._getAdaptationControlInstance().getControlDelegate();if(e.indexOf(t)<0){const e=n.removeItem.call(n,this._getAdaptationControlInstance(),t).then(e=>{if(e&&this._mOriginalsForClone[t]){this._mOriginalsForClone[t].destroy();delete this._mOriginalsForClone[t]}});i.push(e)}});return Promise.all(i)};d.prototype._checkAdvancedParent=function(t){if(!t.isA("sap.ui.mdc.IFilterSource")&&!t.isA("sap.ui.mdc.IFilter")){throw new Error("The 'adaptationControl' needs to implement the IFilterSource or IFilter interface")}return t.isA("sap.ui.mdc.IFilter")};d.prototype.setAdaptationControl=function(t,e){if(this._fnResolveAdaptationControlPromise){this._fnResolveAdaptationControlPromise();this._fnResolveAdaptationControlPromise=null}this.setAssociation("adaptationControl",t,e);this._cLayoutItem=a;this._oFilterBarLayout=this._checkAdvancedParent(t)?new o:new s;this._oFilterBarLayout.getInner().setParent(this);this.setAggregation("layout",this._oFilterBarLayout,true);if(this._oFilterBarLayout.getInner().attachChange){this._oFilterBarLayout.getInner().attachChange(t=>{const e=t.getParameter("reason");const i=t.getParameter("item");if(this._checkIsNewUI()){if(this._oFilterBarLayout.getInner().isA("sap.ui.mdc.p13n.panels.AdaptFiltersPanel")){if(e==="Show"||e==="Hide"){this._checkFilterState(i)}else if(e==="Filter"){this._checkFilterValue(i)}}if(e==="Add"){this._checkFilterState(i);this._checkFilterValue(i)}}if(e==="Remove"){const t={};t[this.mFilterFields[i.name].getPropertyKey()]=[];return this.getEngine().createChanges({control:this,applyAbsolute:true,key:"Filter",state:t}).then(()=>{this.fireChange()})}this.fireChange({_skipValidation:this._oFilterBarLayout.getInner().isA("sap.ui.mdc.p13n.panels.AdaptFiltersPanel")})})}return this};d.prototype._determineValidationState=function(){return this.awaitControlDelegate().then(t=>{if("getFilterDelegate"in t&&typeof t.getFilterDelegate==="function"&&"determineValidationState"in t.getFilterDelegate()){t=t.getFilterDelegate()}return t.determineValidationState(this,this.checkFilters())})};d.prototype._getAdaptationControlInstance=function(){const e=this.getAdaptationControl();return e&&t.getElementById(e)};d.prototype._validateAdaptationState=function(){const t=this.getP13nData().items;if(!t||t.length===0){return}t.forEach(t=>{if(this.mFilterFields&&this.mFilterFields[t.name]){this._checkFilterState(t);this._checkFilterValue(t)}})};d.prototype._checkFilterState=function(t){const e=this.mFilterFields?.[t.name];if(!e){return}const i=e.getConditions().length>0;if(t.required&&!t.visible&&!i){e.setValueState(u.Warning);e.setValueStateText("Hiding required filters makes it difficult to filter data.")}else if(!t.required&&!t.visible&&!i){e.setValueState(u.Warning);e.setValueStateText("If invisible and empty, this filter will be removed.")}else if(!t.visible&&i){e.setValueState(u.Information);e.setValueStateText("The filter will not show on the filter bar.")}else{e.setValueState(u.None);e.setValueStateText()}};d.prototype._checkFilterValue=function(t){const e=this.mFilterFields?.[t.name];if(!e){return}const i=e.getConditions().length>0;if(t.required&&!i){e.setValueState(u.Warning);e.setValueStateText(`${t.label} is a required filter.`)}else if(!t.visible&&!t.required&&!i){e.setValueState(u.Warning);e.setValueStateText("If invisible and empty, this filter will be removed.")}else if(!t.visible&&i){e.setValueState(u.Information);e.setValueStateText("The filter will not show on the filter bar.")}else{e.setValueState(u.None);e.setValueStateText()}};d.prototype._checkIsNewUI=function(){if(this._bUseNewUI===undefined){this._bUseNewUI=new URLSearchParams(window.location.search).get("sap-ui-xx-new-adapt-filters")==="true"}return this._bUseNewUI};d.prototype.exit=function(){this.getEngine().defaultProviderRegistry.detach(this);l.prototype.exit.apply(this,arguments);for(const t in this._mOriginalsForClone){this._mOriginalsForClone[t].destroy()}this._mOriginalsForClone=null;this.oAdaptationData=null;this.mFilterFields=null;this._fnResolveAdaptationControlPromise=null;this._oAdaptationControlPromise=null};return d});
//# sourceMappingURL=AdaptationFilterBar.js.map