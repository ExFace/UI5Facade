/*!
 * OpenUI5
 * (c) Copyright 2026 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/core/Lib","sap/ui/core/library","sap/base/Log","sap/base/util/deepExtend","./Validators","./BindingHelper","./BindingResolver","./DateRangeHelper","./Duration","./ComboBoxHelper","./RadioButtonHelper"],function(e,t,r,o,i,a,n,s,l,u,d,p){"use strict";var f=r.ValueState;var c=e.extend("sap.ui.integration.util.Form",{constructor:function(t){e.apply(this);this._oCard=t},metadata:{library:"sap.ui.integration"}});c.prototype.init=function(){this._mControls=new Map};c.prototype.exit=function(){this._mControls.clear();delete this._mControls;delete this._oCard};c.prototype.addControl=function(e,t,r,o){if(!this._isValidControlId(r.id)){return}this._syncToFormModelOn(e,t,r,o)};c.prototype.validate=function(e,t){var r=false;this._mControls.forEach(function(t){if(this._validateControl(t,e)){r=true}}.bind(this));if(r&&!t){this._oCard.scheduleFireStateChanged()}};c.prototype.resolveControl=function(e){var t={},r=this.getModel("form").getProperty("/"+e.id),o=this.getModel("messages").getProperty("/records"),i=o.find(function(t){return t.bindingPath==="/"+e.id}),a=this._mControls.get(e.id);if(i&&(a&&a._bShowValueState)){t.valueState={message:i.message,type:i.type}}switch(e.type){case"ComboBox":t.selectedKey=r.key;t.value=r.value;break;case"DateRange":t.value=r.value;break;case"RadioButtonGroup":t.selectedIndex=r.selectedIndex;t.selectedKey=r.selectedKey;break;default:t.value=r;break}return t};c.prototype.setControlValue=function(e){if(!this._isControlDataValid(e)){return}var t=e.id,r=this._mControls.get(t),o=e.value;if(r.isA("sap.m.ComboBox")){d.setValueAndKey(r,e.key,e.value)}else if(r.isA("sap.m.RadioButtonGroup")){p.setSelectedIndexAndKey(r,e.selectedIndex,e.key)}else if(r.isA("sap.m.DatePicker")||r.isA("sap.m.DynamicDateRange")){l.setValue(r,o,this._oCard)}else if(r.isA("sap.m.TimePicker")){r.setValue(u.fromISO(o))}else{r.setValue(o)}this._validateAndUpdate(r)};c.prototype.updateModel=function(){this._mControls.forEach(this._updateModel.bind(this))};c.prototype._isValidControlId=function(e){if(!e){o.error("Each input control must have an ID.","sap.ui.integration.widgets.Card");return false}if(this._mControls.has(e)){o.error("Duplicate form control ID - '"+e+"'","sap.ui.integration.widgets.Card");return false}return true};c.prototype._syncToFormModelOn=function(e,t,r,o){this._prepareValidationForControl(t,r,o);t.attachEvent(e,this._validateAndUpdate,this);if(r.value&&!n.isBindingInfo(r.value)){this._updateModel(t)}this._mControls.set(r.id,t)};c.prototype._updateModel=function(e){this.getModel("form").setProperty("/"+e._oItem.id,g(e))};c.prototype._validateAndUpdate=function(e){var t=e.getSource?e.getSource():e;this._validateControl(t,true);this._updateModel(t);this._oCard.scheduleFireStateChanged()};c.prototype._isControlDataValid=function(e){if(!e){return false}var t=e.id;if(!t){o.error("Form control data is missing property 'id'.","sap.ui.integration.widgets.Card");return false}var r=this._mControls.get(t);if(!r){o.error("Form control with ID - '"+t+"' does not exist.","sap.ui.integration.widgets.Card");return false}if(r.isA(["sap.m.TextArea","sap.m.Input"])&&!("value"in e)){o.error("Form data for control ID - '"+t+"' is missing property 'value'.","sap.ui.integration.widgets.Card");return false}if(r.isA("sap.m.ComboBox")){if(!("value"in e)&&!("key"in e)){o.error("Form data for control ID - '"+t+"' requires properties 'key' or 'value'.","sap.ui.integration.widgets.Card");return false}}if(r.isA("sap.m.DatePicker")||r.isA("sap.m.DynamicDateRange")){if(!("value"in e)){o.error("Form data for control ID - '"+t+"' is missing property 'value'.","sap.ui.integration.widgets.Card");return false}if(e.value!==null&&(!("option"in e.value)||!("values"in e.value))){o.error("Form data for control ID - '"+t+"' requires property 'value' to contain 'option' and 'values'.","sap.ui.integration.widgets.Card");return false}}if(r.isA("sap.m.RadioButtonGroup")){if("selectedIndex"in e||"key"in e){return true}o.error("Form data for control ID - '"+t+"' requires property 'selectedIndex' or 'selectedKey'.","sap.ui.integration.widgets.Card");return false}return true};c.prototype._prepareValidationForControl=function(e,t,r){var o=i({},t);if(o.validations){o.validations.forEach(function(e,t){if(e.pattern){e.pattern=this._oCard.getManifestEntry(r+"/validations/"+t)["pattern"]}}.bind(this))}e._oItem=o};c.prototype._validateControl=function(e,t){var r=this._oCard.getAggregation("_extension"),o=e._oItem,i=e.getBindingContext(),a=i?i.getPath():"",n=false,l;this._removeMessageFromControl(e);if(!o){return n}n=!this._checkBuiltInValidations(e,o,t);if(!n&&o.validations){l=s.resolveValue(o.validations,e,a);n=!l.every(function(i){return this._checkValidationItem(i,e,o,t,r)}.bind(this))}this._updateMessageModel();return n};c.prototype._checkValidationItem=function(e,r,o,i,n){var s=a[this._getFormControlType(o)],l,u,d,p,c=true;for(var h in e){l=e[h];if(h==="validate"){d=this._getExtensionFunctionName(l,n);if(d){p=n[d]}}else{p=s[h]}if(typeof p!=="function"){continue}u=p(g(r),l);if(!u){this._addMessageToControl(r,i,{type:e.type||f.Error,message:e.message||t.getResourceBundleFor("sap.ui.integration").getText(s[h+"Txt"],[l]),bindingPath:"/"+o.id});c=false;break}}return c};c.prototype._checkBuiltInValidations=function(e,r,o){var i=true;if(e.isA("sap.m.DatePicker")&&!e.isValidValue()){this._addMessageToControl(e,o,{type:f.Error,message:t.getResourceBundleFor("sap.ui.core").getText("VALUE_STATE_ERROR"),bindingPath:"/"+r.id});i=false}return i};c.prototype._addMessageToControl=function(e,t,r){var o=this.getModel("messages"),i=o.getData();i.records.push(r);o.setData(i);if(t||e._bShowValueState){e._bShowValueState=true;e.setValueState(r.type);if(e.setValueStateText){e.setValueStateText(r.message)}}this._updateMessageModel()};c.prototype._removeMessageFromControl=function(e){var t=this.getModel("messages"),r="/"+e._oItem.id,o=t.getData(),i=false;e.setValueState(f.None);for(var a=0;a<o.records.length;a++){if(o.records[a].bindingPath===r){o.records.splice(a,1);i=true;break}}if(i){t.setData(o)}this._updateMessageModel()};c.prototype._updateMessageModel=function(){var e=this.getModel("messages"),t=e.getProperty("/records");e.setProperty("/hasErrors",t.some(function(e){return e.type===f.Error}));e.setProperty("/hasWarnings",t.some(function(e){return e.type===f.Warning}))};c.prototype.getRequiredValidationValue=function(e){var t=e.validations||[],r,o,i;for(o=0;o<t.length;o++){r=t[o];for(i in r){if(i==="required"){return r[i]}}}return false};c.prototype._getExtensionFunctionName=function(e,t){if(!e.startsWith("extension.")){o.error("Validation function should start with 'extension'.");return false}if(!t){o.error("Extension is not defined.");return false}var r=e.replace("extension.","");if(!t[r]){o.error("No such function.",r,"sap.ui.integration.widgets.Card");return false}return r};c.prototype._getFormControlType=function(e){switch(e.type){case"ComboBox":return"keyValuePair";case"DateRange":return"dateRange";case"RadioButtonGroup":return"radioButtonGroup";default:return"string"}};function g(e){if(e.isA("sap.m.ComboBox")){e.synchronizeSelection();return{key:e.getSelectedKey(),value:e.getValue()}}else if(e.isA("sap.m.RadioButtonGroup")){return p.getValueForModel(e)}else if(e.isA("sap.m.DynamicDateRange")||e.isA("sap.m.DatePicker")){return l.getValueForModel(e)}else if(e.isA("sap.m.TimePicker")){return u.toISO(e.getValue())}else{return e.getValue()}}return c});
//# sourceMappingURL=Form.js.map