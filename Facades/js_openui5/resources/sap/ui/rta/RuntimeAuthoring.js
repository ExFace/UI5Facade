/*!
 * OpenUI5
 * (c) Copyright 2026 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/strings/capitalize","sap/base/Log","sap/m/MessageBox","sap/m/MessageToast","sap/ui/base/ManagedObject","sap/ui/core/BusyIndicator","sap/ui/core/Lib","sap/ui/dt/DesignTime","sap/ui/dt/DOMUtil","sap/ui/dt/ElementUtil","sap/ui/dt/Overlay","sap/ui/dt/Util","sap/ui/events/KeyCodes","sap/ui/fl/apply/api/FlexRuntimeInfoAPI","sap/ui/fl/initial/_internal/ManifestUtils","sap/ui/fl/initial/api/Version","sap/ui/fl/write/api/ContextBasedAdaptationsAPI","sap/ui/fl/write/api/ControlPersonalizationWriteAPI","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/write/api/PersistenceWriteAPI","sap/ui/fl/write/api/ReloadInfoAPI","sap/ui/fl/write/api/TranslationAPI","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/requireAsync","sap/ui/fl/Utils","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement","sap/ui/rta/appVariant/Feature","sap/ui/rta/command/BaseCommand","sap/ui/rta/command/LREPSerializer","sap/ui/rta/command/Stack","sap/ui/rta/toolbar/Fiori","sap/ui/rta/toolbar/FioriLike","sap/ui/rta/toolbar/Standalone","sap/ui/rta/util/changeVisualization/ChangeVisualization","sap/ui/rta/util/guidedTour/content/GeneralTour","sap/ui/rta/util/guidedTour/GuidedTour","sap/ui/rta/util/whatsNew/WhatsNew","sap/ui/rta/util/PluginManager","sap/ui/rta/util/PopupManager","sap/ui/rta/util/ReloadManager","sap/ui/rta/util/ServiceManager","sap/ui/rta/util/validateFlexEnabled","sap/ui/rta/Utils","sap/ui/Device"],function(t,e,o,i,a,n,s,r,l,c,d,h,u,g,p,f,S,m,y,C,A,_,b,R,w,v,M,T,E,P,D,I,O,L,N,V,x,U,k,B,F,z,G,K,H,W,$){"use strict";const j="STARTING";const Y="STARTED";const q="STOPPED";const J="FAILED";const Z="sap.ui.rta.RuntimeAuthoring.parametersAfterRestart";const Q=a.extend("sap.ui.rta.RuntimeAuthoring",{metadata:{library:"sap.ui.rta",associations:{rootControl:{type:"sap.ui.base.ManagedObject"}},properties:{showToolbars:{type:"boolean",defaultValue:true,group:"restoreAfterReload"},showWindowUnloadDialog:{type:"boolean",defaultValue:true,group:"restoreAfterReload"},commandStack:{type:"any"},flexSettings:{type:"object",defaultValue:{layer:R.CUSTOMER,developerMode:true},group:"restoreAfterReload"},mode:{type:"string",defaultValue:"adaptation"},metadataScope:{type:"string",defaultValue:"default",group:"restoreAfterReload"},hideReset:{type:"boolean",defaultValue:false,group:"restoreAfterReload"}},events:{start:{parameters:{editablePluginsCount:{type:"int"}}},stop:{},failed:{parameters:{error:{type:"any"}}},selectionChange:{parameters:{selection:{type:"sap.ui.dt.Overlay[]"}}},modeChanged:{},undoRedoStackModified:{}}},_sAppTitle:null,_dependents:null,_sStatus:q,_bNavigationModeWarningShown:false,constructor:function(...t){a.apply(this,t);this._dependents={};this._mUShellServices={};this._pElementModified=Promise.resolve();this.addDependent(new F,"pluginManager");this.addDependent(new z,"popupManager");this.addDependent(new K,"serviceManager");if(this.getShowToolbars()){this.getPopupManager().attachOpen(it,this);this.getPopupManager().attachClose(at,this);this.addDependent(new x,"changeVisualization")}this.pServices=Promise.resolve();if(window.parent!==window){this.pServices=this.getService("receiver")}this.pServices=this.pServices.then(this.getService.bind(this,"supportTools"));this._loadUShellServicesPromise=M.getUShellServices(["AppLifeCycle","Navigation"]).then(function(t){this._mUShellServices=t;G.setUShellServices(t);return y.isSeenFeaturesAvailable()}.bind(this)).then(function(t){if(t){this.addDependent(new B({layer:this.getLayer()}),"whatsNew")}this.addDependent(new k,"guidedTour");return Promise.resolve()}.bind(this))}});Q.prototype.applySettings=function(...t){const e={...t[0]};const o=window.sessionStorage.getItem(Z);const i=Object.values(this.getMetadata().getProperties()).filter(t=>t.group==="restoreAfterReload");if(o){const t=JSON.parse(o);t.forEach(function(t){if(i.find(e=>e.name===t.name)){e[t.name]=t.value}});window.sessionStorage.removeItem(Z)}a.prototype.applySettings.apply(this,[e,t[1]])};Q.prototype.addDependent=function(e,o,i){i=typeof i==="undefined"?true:!!i;if(!(o in this._dependents)){if(o&&i){this[`get${t(o,0)}`]=this.getDependent.bind(this,o)}this._dependents[o||e.getId()]=e}else{throw h.createError("RuntimeAuthoring#addDependent",`Can't add dependency with same key '${o}'`,"sap.ui.rta")}};Q.prototype.getDependent=function(t){return this._dependents[t]};Q.prototype.getDependents=function(){return this._dependents};Q.prototype.removeDependent=function(t){delete this._dependents[t]};Q.prototype.setPlugins=function(t){if(this._sStatus!==q){throw Error("Cannot replace plugins: runtime authoring already started")}this.getPluginManager().setPlugins(t)};Q.prototype.getPlugins=function(){return this.getPluginManager&&this.getPluginManager()&&this.getPluginManager().getPlugins()};Q.prototype.getDefaultPlugins=function(){return this.getPluginManager().getDefaultPlugins(this.getFlexSettings())};Q.prototype.setFlexSettings=function(t){const e=new URLSearchParams(window.location.search);const o=e.get("sap-ui-layer");t={...this.getFlexSettings(),...t};if(o){t.layer=o.toUpperCase()}if(t.scenario||t.baseId){const e=M.buildLrepRootNamespace(t.baseId,t.scenario,t.projectId);t.rootNamespace=e;t.namespace=`${e}changes/`}W.setRtaStyleClassName(t.layer);this.setProperty("flexSettings",t)};Q.prototype.getLayer=function(){return this.getFlexSettings().layer};Q.prototype.getRootControlInstance=function(){this._oRootControl||=c.getElementInstance(this.getRootControl());return this._oRootControl};Q.prototype._getTextResources=function(){return s.getResourceBundleFor("sap.ui.rta")};Q.prototype.start=async function(){if(this._sStatus!==q){throw Error("RuntimeAuthoring is already started")}this._sStatus=j;const t=this.getRootControlInstance();if(!t){throw Error("Root control not found")}try{await this._loadUShellServicesPromise;await Lt.call(this);await Nt.call(this,Q.needsRestart(this.getLayer()));const e=await G.handleReloadOnStart({layer:this.getLayer(),selector:t,versioningEnabled:this._oVersionsModel.getProperty("/versioningEnabled"),developerMode:this.getFlexSettings().developerMode,adaptationId:this._oContextBasedAdaptationsModel.getProperty("/displayedAdaptation/id")});if(e){const t=Object.values(this.getMetadata().getProperties()).filter(t=>t.group==="restoreAfterReload").map(t=>({name:t.name,value:t.get(this)}));window.sessionStorage.setItem(Z,JSON.stringify(t));throw Error("Reload triggered")}C.setAdaptationLayer(this.getLayer(),t);const o=C.getResetAndPublishInfoFromSession(t);this.bInitialResetEnabled=!!o.isResetEnabled;this._oSerializer=new I({commandStack:this.getCommandStack(),rootControl:this.getRootControl()});this.getPluginManager().preparePlugins(this.getFlexSettings(),kt.bind(this),this.getCommandStack());const i=X.call(this);this._oldUnloadHandler=window.onbeforeunload;window.onbeforeunload=this._onUnload.bind(this);if(this.getShowToolbars()){const e=await lt(t,this.getLayer(),this._oSerializer);await Vt.call(this,e)}await ht.call(this);d.getOverlayContainer().style.setProperty("--sap-ui-rta-scrollbar-scrollWidth",`${l.getScrollbarWidth()}px`);d.getOverlayContainer().style.setProperty("--sap-ui-rta-scrollbar-scrollWidthPlusTwo",`${l.getScrollbarWidth()+2}px`);await i;if(this.getChangeVisualization){this.getChangeVisualization()._oDesignTime=this._oDesignTime}et.call(this,true);const a=await y.getSeenFeatureIds({layer:this.getLayer()});const n=await ct(this.getRootControlInstance(),this.getLayer(),a);const s="sap.ui.rta.dontShowWhatsNewAfterReload";const r=this.getWhatsNew&&!window.sessionStorage.getItem(s);if(n){const t=this.getGuidedTour();t.attachTourClosed(()=>{if(r){const t=["GuidedTour"];this.getWhatsNew().initializeWhatsNewDialog(a,t);window.sessionStorage.setItem(s,true)}});t.autoStart(U.getTourContent())}else if(r){this.getWhatsNew().initializeWhatsNewDialog(a);window.sessionStorage.setItem(s,true)}this.getPopupManager().setRta(this);if(this.getShowToolbars()){await this.getToolbar().show()}this.fnKeyDown=pt.bind(this);document.addEventListener("keydown",this.fnKeyDown);this.fnOnPersonalizationChangeCreation=nt.bind(this);m.attachChangeCreation(t,this.fnOnPersonalizationChangeCreation);ot.call(this);this._sStatus=Y;Q.disableRestart(this.getLayer());this.fireStart({editablePluginsCount:this.getPluginManager().getEditableOverlaysCount()});await this.pServices}catch(t){if(t.message==="Reload triggered"){this.destroy()}else{this._sStatus=J;this.fireFailed({vError:t.message})}throw t}};function X(){const t=this.getPluginManager().getPluginList();return new Promise(function(e,o){E.start("rta.dt.startup","Measurement of RTA: DesignTime start up");this._oDesignTime=new r({scope:this.getMetadataScope(),plugins:t});rt(this.getRootControlInstance(),true);this._oDesignTime.addRootElement(this._oRootControl);d.getOverlayContainer().classList.add("sapUiRta");document.body.classList.add("sapUiRtaMode");this._oDesignTime.getSelectionManager().attachChange(function(t){this.fireSelectionChange({selection:t.getParameter("selection")})},this);this._oDesignTime.attachEventOnce("synced",function(){e();E.end("rta.dt.startup","Measurement of RTA: DesignTime start up")},this);this._oDesignTime.attachEventOnce("syncFailed",function(t){o(t.getParameter("error"))})}.bind(this))}function tt(){const t=this._oVersionsModel.getProperty("/versioningEnabled");const e=t?"MSG_UNSAVED_DRAFT_CHANGES_ON_CLOSE":"MSG_UNSAVED_CHANGES_ON_CLOSE";const o=t?"BTN_UNSAVED_DRAFT_CHANGES_ON_CLOSE_SAVE":"BTN_UNSAVED_CHANGES_ON_CLOSE_SAVE";return W.showMessageBox("warning",e,{titleKey:"TIT_UNSAVED_CHANGES_ON_CLOSE",actionKeys:[o,"BTN_UNSAVED_CHANGES_ON_CLOSE_DONT_SAVE"],emphasizedActionKey:"BTN_UNSAVED_CHANGES_ON_CLOSE_SAVE",showCancel:true})}Q.prototype.stop=async function(t,e,i){let a;let n;ut.call(this,"setBusy",true);try{t||=!C.hasDirtyChanges({selector:this.getRootControlInstance()});await gt.call(this);if(!t&&this.canSave()&&!i){const t=await tt.call(this);if(t===o.Action.CANCEL){a=true;throw Error()}if(t===this._getTextResources().getText("BTN_UNSAVED_CHANGES_ON_CLOSE_DONT_SAVE")){await this._oSerializer.clearCommandStack(true)}}const n=window.sessionStorage.getItem("sap.ui.rta.skipReload");if(n){window.sessionStorage.removeItem("sap.ui.rta.skipReload")}const s=e||n?{}:await G.checkReloadOnExit({layer:this.getLayer(),selector:this.getRootControlInstance(),isDraftAvailable:this._oVersionsModel.getProperty("/draftAvailable"),versioningEnabled:this._oVersionsModel.getProperty("/versioningEnabled"),activeVersion:this._oVersionsModel.getProperty("/activeVersion"),changesNeedReloadPromise:this._bSavedChangesNeedReload?Promise.resolve(true):this._oSerializer.needsReload()});if(!t){await this._serializeToLrep(false,true)}ut.call(this,"hide",t);this.fireStop();if(!e){A.removeInfoSessionStorage(this.getRootControlInstance());G.handleReloadOnExit(s)}b.clearInstances()}catch(t){n=true;if(!a){dt(t)}}ut.call(this,"setBusy",false);et.call(this,false);if(!n){this._sStatus=q;document.body.classList.remove("sapUiRtaMode")}};Q.prototype.setCommandStack=function(t){const e=this.getProperty("commandStack");if(e){e.detachModified(ht,this)}if(this._oInternalCommandStack){this._oInternalCommandStack.destroy();delete this._oInternalCommandStack}const o=this.setProperty("commandStack",t);if(t){t.attachModified(ht,this)}if(this.getPluginManager&&this.getPluginManager()){this.getPluginManager().provideCommandStack(t)}return o};Q.prototype.getCommandStack=function(){let t=this.getProperty("commandStack");if(!t){t=new O;this._oInternalCommandStack=t;this.setCommandStack(t)}return t};Q.prototype.setMode=function(t){const e=this.getMode();if(e!==t){const o=this.getPluginManager().getPlugin("selection");if(e==="navigation"||t==="navigation"){this._oDesignTime.setEnabled(t!=="navigation");et.call(this,e==="navigation")}const i=this.getChangeVisualization?.();if(t==="visualization"||e==="visualization"){h.waitForSynced(this._oDesignTime)().then(function(){return i.triggerModeChange(this.getRootControl(),this.getToolbar())}.bind(this))}if(e==="adaptation"){this.getPluginManager().handleStopCutPaste()}o.setIsActive(!(t==="visualization"));const a=d.getOverlayContainer();if(t==="visualization"){a.classList.add("sapUiRtaVisualizationMode")}else{a.classList.remove("sapUiRtaVisualizationMode")}if(t==="visualization"){document.querySelectorAll(".sapUiDtOverlayMovable").forEach(function(t){t.style.cursor="default"})}else{document.querySelectorAll(".sapUiDtOverlayMovable").forEach(function(t){t.style.cursor="move"})}this._oToolbarControlsModel.setProperty("/modeSwitcher",t);this.setProperty("mode",t);this.fireModeChanged({mode:t})}};Q.prototype.setMetadataScope=function(t){if(this._sStatus!==q){e.error("sap.ui.rta: Failed to set metadata scope on RTA instance after RTA is started");return}this.setProperty("metadataScope",t)};Q.prototype.destroy=function(...t){const e=Object.keys(this._dependents);e.forEach(function(t){this._dependents[t].destroy(true);this.removeDependent(t)}.bind(this));et.call(this,false);if(this._oDesignTime){this._oDesignTime.destroy();this._oDesignTime=null;document.removeEventListener("keydown",this.fnKeyDown);if(this.fnOnPersonalizationChangeCreation){m.detachChangeCreation(this.getRootControlInstance(),this.fnOnPersonalizationChangeCreation)}}if(this.getRootControlInstance()){rt(this.getRootControlInstance(),false)}this.setCommandStack(null);window.onbeforeunload=this._oldUnloadHandler;a.prototype.destroy.apply(this,t)};Q.needsRestart=function(t){return G.needsAutomaticStart(t)};Q.enableRestart=function(t,e){G.enableAutomaticStart(t,e)};Q.disableRestart=function(t){G.disableAutomaticStart(t)};Q.willRTAStartAfterReload=function(t){return G.needsAutomaticStart(t||R.CUSTOMER)};Q.prototype.getSelection=function(){if(this._oDesignTime){return this._oDesignTime.getSelectionManager().get()}return[]};Q.prototype.restore=function(){const t=this.getLayer();const e="FORM_PERS_RESET_MESSAGE";const i="FORM_PERS_RESET_TITLE";this.getPluginManager().handleStopCutPaste();return W.showMessageBox("warning",e,{titleKey:i,actions:[o.Action.OK,o.Action.CANCEL],emphasizedAction:o.Action.OK}).then(function(e){if(e===o.Action.OK){Q.enableRestart(t,this.getRootControlInstance());return xt.call(this)}return undefined}.bind(this))};Q.prototype.undo=function(){this.getPluginManager().handleStopCutPaste();return this.getCommandStack().undo()};Q.prototype.redo=function(){this.getPluginManager().handleStopCutPaste();return this.getCommandStack().redo()};Q.prototype.canUndo=function(){return this.getCommandStack().canUndo()};Q.prototype.canSave=function(){return this.getCommandStack().canSave()};Q.prototype.canRedo=function(){return this.getCommandStack().canRedo()};Q.prototype.save=function(){return gt.call(this).then(this._serializeToLrep.bind(this))};Q.prototype._serializeToLrep=function(t,e,o){if(!this._bSavedChangesNeedReload){return this._oSerializer.needsReload().then(function(i){this._bSavedChangesNeedReload=i;return mt.call(this,o,t,e)}.bind(this))}return mt.call(this,o,t,e)};Q.prototype.condenseAndSaveChanges=function(...t){return this._serializeToLrep(...t)};Q.prototype._onUnload=function(){if(this.canSave()&&this.getShowWindowUnloadDialog()){return this._getTextResources().getText("MSG_UNSAVED_CHANGES")}window.onbeforeunload=this._oldUnloadHandler;return undefined};function et(t){this._oDesignTime?.getRootElements().forEach(e=>{const o=e.isA("sap.ui.core.Component")?e.getRootControl():e;o?.setBlocked(t)})}function ot(){const t=new URLSearchParams(window.location.search).get("sap-ui-rta-skip-flex-validation");const e=g.isCustomerSystem();if(!e&&t!=="true"){H(this)}}function it(t){const e=t.getParameters().getSource();if(e.isA("sap.m.Dialog")&&this.getToolbar().type==="fiori"){this.getToolbar().setColor("contrast")}this.getToolbar().bringToFront()}function at(t){if(t.getParameters().isA("sap.m.Dialog")){this.getToolbar().setColor()}}function nt(){if(this.getMode()==="navigation"&&!this._bNavigationModeWarningShown){st.call(this,"MSG_NAVIGATION_MODE_CHANGES_WARNING",{duration:5e3});this._bNavigationModeWarningShown=true}}function st(t,e){const o=this._getTextResources().getText(t);i.show(o,e||{})}function rt(t,e){if(t.isA("sap.ui.core.UIComponent")){t=t.getRootControl()}if(t){t[e?"addStyleClass":"removeStyleClass"]("sapUiRtaRoot")}}async function lt(t,e,o){const i=await y.isPublishAvailable();const a=await P.isSaveAsAvailable(t,e,o);const n=await y.isContextBasedAdaptationAvailable(e);const s=await M.getUShellService("AppLifeCycle");const r=s?.getCurrentApplication()?.homePage||false;const l=M.getAppDescriptor(t);const c=l&&!p.getOvpEntry(l);return{publishAvailable:i,saveAsAvailable:!r&&i&&a,contextBasedAdaptationAvailable:!r&&c&&n}}async function ct(t,e,o){const i=M.getConnectors();const a=["LocalStorageConnector","SessionStorageConnector"];const n=i.length>0;const s=n&&i.every(t=>!a.includes(t));const r="sap.ui.rta.dontShowUIAdaptationTourAfterReload";if(!s||w.isDeveloperLayer(e)||window.sessionStorage.getItem(r)){return false}const l=await g.getUserId();if(l==="DEFAULT_USER"||!l){return false}const c=await C._getFlexObjectsForUser({selector:t,layer:e,includeManifestChanges:true,includeAnnotationChanges:true});const d=b.getCreatedVersionsByUser({layer:e,control:t},l);let h=true;if(!c||c.length>0||d.length>0||o.length>0){h=false}if(h){window.sessionStorage.setItem(r,true)}return h}function dt(t){n.hide();const i=t.userMessage||t.stack||t.message||t.status||t;const a=s.getResourceBundleFor("sap.ui.rta");e.error("Failed to transfer changes",i);const r=`${a.getText("MSG_LREP_TRANSFER_ERROR")}\n\t\t\t${a.getText("MSG_ERROR_REASON",[i])}`;o.error(r,{styleClass:W.getRtaStyleClassName()})}async function ht(){const t=!this.getShowToolbars()||!this.getCommandStack().canUndo();try{const e=await W.checkDraftOverwrite(this._oVersionsModel,t);if(e){await b.discardDraft({layer:this.getLayer(),control:this.getRootControlInstance(),updateState:true,discardDraftAndKeepActiveVersion:true})}if(this.getShowToolbars()){const t=this.getCommandStack();const e=t.canUndo();const o=t.canRedo();const i=t.canSave();const a=t.getSaved();const n=this._oToolbarControlsModel.getProperty("/translation/visible")&&_.hasTranslationRelevantDirtyChanges({layer:R.CUSTOMER,selector:this.getRootControlInstance()});this._oVersionsModel.setDirtyChanges(C.hasDirtyChanges({selector:this.getRootControlInstance()}));this._oToolbarControlsModel.setProperty("/undo/enabled",e);this._oToolbarControlsModel.setProperty("/redo/enabled",o);this._oToolbarControlsModel.setProperty("/save/enabled",i);this._oToolbarControlsModel.setProperty("/restore/enabled",this.bInitialResetEnabled||i||a);this._oToolbarControlsModel.setProperty("/translation/enabled",this.bPersistedDataTranslatable||n);const s=this._bSavedChangesNeedReload||await this._oSerializer.needsReload();this._oToolbarControlsModel.setProperty("/changesNeedHardReload",s)}this.fireUndoRedoStackModified()}catch(t){this.undo()}}function ut(t,e){if(this.getShowToolbars()&&this.getToolbar&&this.getToolbar()){return this.getToolbar()[t](e)}return undefined}async function gt(){await(this._oDesignTime?.waitForBusyPlugins());return this._pElementModified}function pt(t){const e=$.os.macintosh;const o=d.getOverlayContainer().contains(document.activeElement);const i=this.getShowToolbars()&&this.getToolbar().getDomRef().contains(document.activeElement);let a=false;document.querySelectorAll(".sapUiDtContextMenu").forEach(function(t){if(t.contains(document.activeElement)){a=true}});const n=document.body===document.activeElement;const s=l.getParents(document.activeElement,".sapUiRtaEditableField").length>0;if((o||i||a||n)&&!s){const o=e?t.metaKey:t.ctrlKey;if(t.keyCode===u.Z&&t.shiftKey===false&&t.altKey===false&&o===true){this.undo().then(t.stopPropagation.bind(t))}else if((e&&t.keyCode===u.Z&&t.shiftKey===true||!e&&t.keyCode===u.Y&&t.shiftKey===false)&&t.altKey===false&&o===true){this.redo().then(t.stopPropagation.bind(t))}}}async function ft(){if(this.canSave()){const t=await W.showMessageBox("information","MSG_SAVE_AND_RELOAD_DIALOG",{actions:[o.Action.OK,o.Action.CANCEL],emphasizedAction:o.Action.OK});if(t===o.Action.CANCEL){return}}await this.save();if(this._oVersionsModel.getProperty("/versioningEnabled")){if(Ot.call(this)){await b.loadDraftForApplication({control:this.getRootControlInstance(),layer:this.getLayer()})}else{await b.loadVersionForApplication({control:this.getRootControlInstance(),layer:this.getLayer(),version:this._oVersionsModel.getProperty("/displayedVersion")})}}Q.enableRestart(this.getLayer(),this.getRootControlInstance());await this.stop(true,true,true);G.triggerReload({})}function St(t){const e=t.getParameter("callback")||function(){};const o=this._oVersionsModel.getProperty("/versioningEnabled");return this.save().then(function(){st.call(this,o?"MSG_SAVE_DRAFT_SUCCESS":"MSG_SAVE_SUCCESS",{duration:5e3})}.bind(this)).catch(function(t){return dt(t)}).then(e)}async function mt(t,e,o){if(this.getShowToolbars()){this.bPersistedDataTranslatable=this._oToolbarControlsModel.getProperty("/translation/enabled")}const i={layer:this.getLayer(),removeOtherLayerChanges:true,condenseAnyLayer:e};if(this._oVersionsModel.getProperty("/versioningEnabled")){const e=this._oVersionsModel.getProperty("/displayedVersion");let a=t?e:undefined;a||=o?undefined:f.Number.Draft;i.version=a;i.saveAsDraft=this.getLayer()===R.CUSTOMER&&e===f.Number.Draft}if(this._oContextBasedAdaptationsModel.getProperty("/contextBasedAdaptationsEnabled")){i.adaptationId=o?undefined:this._oContextBasedAdaptationsModel.getProperty("/displayedAdaptation/id")}await this._oSerializer.saveCommands(i);if(!o&&this.getChangeVisualization){const t=this.getToolbar();const e=this.getChangeVisualization();e.updateAfterSave(t)}}async function yt(t){const e=t.getParameter("versionTitle");if(It.call(this)&&Ot.call(this)){const t=await W.showMessageBox("warning","MSG_DRAFT_DISCARD_ON_REACTIVATE_DIALOG",{titleKey:"TIT_DRAFT_DISCARD_ON_REACTIVATE_DIALOG",actions:[o.Action.OK,o.Action.CANCEL],emphasizedAction:o.Action.OK});if(t===o.Action.OK){return Ct.call(this,e)}}return Ct.call(this,e)}async function Ct(t){const e=this.getLayer();const o=this.getRootControlInstance();const i=this._oVersionsModel.getProperty("/displayedVersion");try{await this._serializeToLrep(false,false,true);await b.activate({layer:e,control:o,title:t,displayedVersion:i});await C.updateResetAndPublishInfo({selector:o,layer:e});st.call(this,"MSG_DRAFT_ACTIVATION_SUCCESS");this.getPluginManager().getPlugin("toolHooks").setVersionWasActivated(true);this.bInitialResetEnabled=true;this._oToolbarControlsModel.setProperty("/restore/enabled",true);this.getCommandStack().removeAllCommands()}catch(t){W.showMessageBox("error","MSG_DRAFT_ACTIVATION_FAILED",{error:t})}}async function At(){const t=await W.showMessageBox("warning","MSG_DRAFT_DISCARD_DIALOG",{actions:[o.Action.OK,o.Action.CANCEL],emphasizedAction:o.Action.OK});if(t===o.Action.OK){await b.discardDraft({layer:this.getLayer(),control:this.getRootControlInstance(),updateState:true});await _t.call(this)}}function _t(){const t=this.getLayer();const e={removeDraft:true,selector:this.getRootControlInstance()};Q.enableRestart(t,this.getRootControlInstance());this.getCommandStack().removeAllCommands();G.triggerReload(e);return this.stop(true,true)}function bt(){if(this.canSave()){Rt.call(this,"DAC_DATA_LOSS_DIALOG_DESCRIPTION","DAC_DIALOG_HEADER",true)}else{Rt.call(this,"DAC_DIALOG_DESCRIPTION","DAC_DIALOG_HEADER")}}function Rt(t,e,i){W.showMessageBox("confirm",t,{titleKey:e}).then(function(t){if(t===o.Action.OK){n.show();if(i){this.getCommandStack().removeAllCommands(true)}wt.call(this)}}.bind(this))}function wt(){E.start("onCBADeleteAdaptation","Measurement of deleting a context-based adaptation");S.remove({control:this.getRootControlInstance(),layer:this.getLayer(),adaptationId:this._oContextBasedAdaptationsModel.getProperty("/displayedAdaptation/id")}).then(function(){n.hide();const t=this._oContextBasedAdaptationsModel.deleteAdaptation();Tt.call(this,t);E.end("onCBADeleteAdaptation");if(E.getActive()){e.info(`onCBADeleteAdaptation: ${E.getMeasurement("onCBADeleteAdaptation").time} ms`)}}.bind(this)).catch(function(t){n.hide();e.error(t.stack);const o="MSG_LREP_TRANSFER_ERROR";const i={titleKey:"DAC_DIALOG_HEADER"};i.details=t.userMessage;W.showMessageBox("error",o,i)})}async function vt(t,e,i){if(this.canSave()){const a=await W.showMessageBox("warning",t,{titleKey:e,actions:[o.Action.YES,o.Action.NO,o.Action.CANCEL],emphasizedAction:o.Action.YES});if(a===o.Action.YES){await this._serializeToLrep();await i()}else if(a===o.Action.NO){this.getCommandStack().removeAllCommands(true,true);await i()}}else{await i()}}function Mt(t){E.start("onCBASwitchAdaptation","Measurement of switching a context-based adaptation");const o=t.getParameter("callback")||function(){};if(t.getParameter("trigger")==="SaveAs"){this.getCommandStack().removeAllCommands(true)}const i=t.getParameter("adaptationId");this._sSwitchToAdaptationId=i;return vt.call(this,"MSG_SWITCH_VERSION_DIALOG","BTN_SWITCH_ADAPTATIONS",Tt.bind(this,this._sSwitchToAdaptationId)).then(function(){o();E.end("onCBASwitchAdaptation");if(E.getActive()){e.info(`onCBASwitchAdaptation: ${E.getMeasurement("onCBASwitchAdaptation").time} ms`)}}).catch(function(t){W.showMessageBox("error","MSG_SWITCH_ADAPTATION_FAILED",{error:t});e.error(`sap.ui.rta: ${t.stack||t.message||t}`)})}function Tt(t){const e=this._oVersionsModel.getProperty("/displayedVersion");return Pt.call(this,e,t)}function Et(t){const o=t.getParameter("callback")||function(){};const i=t.getParameter("version");const a=this._oVersionsModel.getProperty("/displayedVersion");if(i===a){return}this._sSwitchToVersion=i;vt.call(this,"MSG_SWITCH_VERSION_DIALOG","TIT_SWITCH_VERSION_DIALOG",Pt.bind(this,this._sSwitchToVersion)).then(o).catch(function(t){W.showMessageBox("error","MSG_SWITCH_VERSION_FAILED",{error:t.stack});e.error(`sap.ui.rta: ${t.stack||t.message||t}`)})}function Pt(t,e){Q.enableRestart(this.getLayer(),this.getRootControlInstance());return b.loadVersionForApplication({control:this.getRootControlInstance(),layer:this.getLayer(),version:t,adaptationId:e}).then(function(){const e={versionSwitch:true,version:t,selector:this.getRootControlInstance()};G.triggerReload(e)}.bind(this))}function Dt(){this.getPluginManager().handleStopCutPaste();return b.publish({selector:this.getRootControlInstance(),styleClass:W.getRtaStyleClassName(),layer:this.getLayer(),version:this._oVersionsModel.getProperty("/displayedVersion")}).then(function(t){if(t!=="Error"&&t!=="Cancel"){i.show(t)}})}function It(){return b.isOldVersionDisplayed({control:this.getRootControlInstance(),layer:this.getLayer()})}function Ot(){return b.isDraftAvailable({control:this.getRootControlInstance(),layer:this.getLayer()})}function Lt(){return b.initialize({control:this.getRootControlInstance(),layer:this.getLayer()}).then(function(t){this._oVersionsModel=t}.bind(this))}function Nt(t){if(!t){S.clearInstances()}return S.initialize({control:this.getRootControlInstance(),layer:this.getLayer()}).then(function(t){this._oContextBasedAdaptationsModel=t}.bind(this))}async function Vt(t){if(this.getDependent("toolbar")){return}const e={id:"sapUIRta_toolbar",rtaInformation:{flexSettings:this.getFlexSettings(),rootControl:this.getRootControlInstance(),commandStack:this.getCommandStack()},textResources:this._getTextResources(),restore:this.restore.bind(this),exit:this.stop.bind(this,false,false,false)};e.publishVersion=Dt.bind(this);e.undo=this.undo.bind(this);e.redo=this.redo.bind(this);e.modeChange=Bt.bind(this);e.activate=yt.bind(this);e.discardDraft=At.bind(this);e.switchVersion=Et.bind(this);e.switchAdaptation=Mt.bind(this);e.deleteAdaptation=bt.bind(this);e.openChangeCategorySelectionPopover=this.getChangeVisualization?this.getChangeVisualization().openChangeCategorySelectionPopover.bind(this.getChangeVisualization()):function(){};e.save=St.bind(this);e.saveAndReload=ft.bind(this);let o;const i=!!M.getUshellContainer();if(i){const t=await v("sap/ushell/api/RTA");e.ushellApi=t;if(W.isOriginalFioriToolbarAccessible()){o=new L(e)}else{o=new N(e)}}else{o=new V(e)}this.addDependent(o,"toolbar");await o.onFragmentLoaded();const a=await y.isKeyUserTranslationEnabled(this.getLayer());const n=t.saveAsAvailable;const s=n&&P.isOverviewExtended();const r=new URLSearchParams(window.location.search);const l=!r.has("fiori-tools-rta-mode")||r.get("fiori-tools-rta-mode")==="false";const c=g.getConfiguredFlexServices().some(function(t){return t.connector!=="LocalStorageConnector"});this.bPersistedDataTranslatable=false;const d=this._bSavedChangesNeedReload||await this._oSerializer.needsReload();this._oToolbarControlsModel=new T({changesNeedHardReload:d,modeSwitcher:this.getMode(),undo:{enabled:false},redo:{enabled:false},save:{enabled:false},translation:{visible:a,enabled:this.bPersistedDataTranslatable},appVariantMenu:{visible:n,enabled:n,overview:{visible:n&&s,enabled:n&&s},manageApps:{visible:n&&!s,enabled:n&&!s},saveAs:{visible:n,enabled:n}},restore:{visible:!this._oVersionsModel.getProperty("/versioningEnabled")&&this.getHideReset()===false,enabled:this.bInitialResetEnabled},contextBasedAdaptation:{visible:t.contextBasedAdaptationAvailable,enabled:t.contextBasedAdaptationAvailable},actionsMenuButton:{enabled:true},visualizationButton:{visible:l,enabled:l},feedbackButton:{visible:c}});this._oVersionsModel.setProperty("/publishVersionVisible",t.publishAvailable);this.getToolbar().setModel(this._oVersionsModel,"versions");this.getToolbar().setModel(this._oContextBasedAdaptationsModel,"contextBasedAdaptations");this.getToolbar().setModel(this._oToolbarControlsModel,"controls");if(a){_.getSourceLanguages({selector:this.getRootControlInstance(),layer:this.getLayer()}).then(function(t){this.bPersistedDataTranslatable=t.length>0;this._oToolbarControlsModel.setProperty("/translation/enabled",this.bPersistedDataTranslatable)}.bind(this))}if(n){const t=M.isVariantByStartupParameter(this.getRootControlInstance())?false:await P.isManifestSupported();this._oToolbarControlsModel.setProperty("/appVariantMenu/enabled",t);this._oToolbarControlsModel.setProperty("/appVariantMenu/saveAs/enabled",t);this._oToolbarControlsModel.setProperty("/appVariantMenu/overview/enabled",t);this._oToolbarControlsModel.setProperty("/appVariantMenu/manageApps/enabled",t)}}function xt(){const t=this.getLayer();const e=M.getAppComponentForControl(this.getRootControlInstance());return C.reset({selector:e,layer:t}).then(function(){this.getCommandStack().removeAllCommands(true);A.removeInfoSessionStorage(e);const t={ignoreMaxLayerParameter:true};return G.triggerReload(t)}.bind(this)).catch(function(t){if(t!=="cancel"){W.showMessageBox("error","MSG_RESTORE_FAILED",{error:t})}})}function Ut(t,e){function o(i){const a=i.getParameter("elementOverlay");if(a.getElement().getId()===t){this._oDesignTime.detachEvent("elementOverlayCreated",o,this);e(a)}}this._oDesignTime.attachEvent("elementOverlayCreated",o,this)}function kt(t){const o=t.getParameter("command");const i=t.getParameter("newControlId");this._pElementModified=this._pElementModified.then(function(){this.getPluginManager().handleStopCutPaste();if(o instanceof D){if(i){Ut.call(this,i,function(t){const e=t.getDesignTimeMetadata();const o=e.getData().select;if(typeof o==="function"){o(t.getElement())}})}return this.getCommandStack().pushAndExecute(o).catch(function(t){if(t?.message?.indexOf?.("The following Change cannot be applied because of a dependency")>-1){W.showMessageBox("error","MSG_DEPENDENCY_ERROR",{error:t})}e.error("sap.ui.rta:",t.message,t.stack)})}return undefined}.bind(this));return this._pElementModified}function Bt(t){this.setMode(t.getParameter("item").getKey())}Q.prototype.getService=function(t){if(this._sStatus!==Y){return new Promise((t,e)=>{this.attachEventOnce("start",t);this.attachEventOnce("failed",e)}).then(()=>this.getServiceManager().startService(t,this)).catch(()=>{throw Error(h.createError("RuntimeAuthoring#getService",`Can't start the service '${t}' because RTA startup failed`,"sap.ui.rta"))})}return this.getServiceManager().startService(t,this)};return Q});
//# sourceMappingURL=RuntimeAuthoring.js.map