/*!
 * OpenUI5
 * (c) Copyright 2025 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/ui/rta/command/FlexCommand","sap/ui/rta/command/ManifestCommand","sap/ui/fl/Utils","sap/ui/dt/ElementUtil","sap/base/Log","sap/ui/fl/write/api/PersistenceWriteAPI"],function(t,e,n,o,a,s,i){"use strict";const r=t.extend("sap.ui.rta.command.LREPSerializer",{metadata:{library:"sap.ui.rta",associations:{rootControl:{type:"sap.ui.core.Control"}},properties:{commandStack:{type:"object"}},aggregations:{}}});function d(t){return a.getElementInstance(t)}r.prototype._lastPromise=Promise.resolve();r.prototype.setCommandStack=function(t){if(this.getCommandStack()){this.getCommandStack().removeCommandExecutionHandler(this._fnHandleCommandExecuted)}this.setProperty("commandStack",t);t.addCommandExecutionHandler(this._fnHandleCommandExecuted)};r.prototype.init=function(){this._fnHandleCommandExecuted=this.handleCommandExecuted.bind(this)};r.prototype.exit=function(){this.getCommandStack().removeCommandExecutionHandler(this._fnHandleCommandExecuted)};r.prototype._isPersistedChange=function(t){return!!this.getCommandStack()._aPersistedChanges&&this.getCommandStack()._aPersistedChanges.indexOf(t.getId())!==-1};r.prototype.handleCommandExecuted=function(t){return function(t){const o=t;this._lastPromise=this._lastPromise.catch(function(){}).then(function(){const t=this.getCommandStack().getSubCommands(o.command);let a;const s=[];if(o.undo){t.forEach(function(t){if(!(t instanceof e||t instanceof n)||t.getRuntimeOnly()){return}const o=t.getPreparedChange();a=t.getAppComponent();if(a){s.push(o)}});if(a){return i.remove({flexObjects:s,selector:a})}return Promise.resolve()}const r=[];t.forEach(function(t){if(t.getRuntimeOnly()){return}if(t instanceof e){a=t.getAppComponent();if(a){const e=t.getPreparedChange();if(!this._isPersistedChange(e)){s.push(t.getPreparedChange())}}}else if(t instanceof n){r.push(t.createAndStoreChange())}}.bind(this));if(a){i.add({flexObjects:s,selector:a})}return Promise.all(r)}.bind(this));return this._lastPromise}.bind(this)(t)};r.prototype.needsReload=function(){this._lastPromise=this._lastPromise.catch(function(){}).then(function(){const t=this.getCommandStack().getAllExecutedCommands();return t.some(function(t){return!!t.needsReload})}.bind(this));return this._lastPromise};r.prototype.saveCommands=function(t){this._lastPromise=this._lastPromise.catch(function(t){s.error(t)}).then(function(){const e=d(this.getRootControl());if(!e){throw new Error("Can't save commands without root control instance!")}return i.save({selector:e,skipUpdateCache:false,draft:!!t.saveAsDraft,layer:t.layer,removeOtherLayerChanges:!!t.removeOtherLayerChanges,version:t.version,adaptationId:t.adaptationId,condenseAnyLayer:t.condenseAnyLayer})}.bind(this)).then(function(){s.info("UI adaptation successfully wrote changes to the persistence");this.getCommandStack().setSaved(true);this.getCommandStack().removeAllCommands()}.bind(this));return this._lastPromise};r.prototype._triggerUndoChanges=function(t){const e=this.getCommandStack();let n=[];const a=e.getAllExecutedCommands();if(t){a.forEach(function(){n.push(e.undo.bind(e))})}else{a.forEach(function(t){n.push(t.undo.bind(t))});n=n.reverse()}return o.execPromiseQueueSequentially(n,false,true)};r.prototype.clearCommandStack=function(t){const e=this.getCommandStack();if(!t){e.detachCommandExecuted(this.handleCommandExecuted.bind(this))}return this._triggerUndoChanges(t).then(function(){e.removeAllCommands();if(!t){e.attachCommandExecuted(this.handleCommandExecuted.bind(this))}return true}.bind(this))};return r});
//# sourceMappingURL=LREPSerializer.js.map