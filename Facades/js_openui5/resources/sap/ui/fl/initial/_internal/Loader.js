/*!
 * OpenUI5
 * (c) Copyright 2026 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/Deferred","sap/base/util/ObjectPath","sap/base/util/uid","sap/base/Log","sap/ui/base/ManagedObject","sap/ui/fl/initial/_internal/FlexInfoSession","sap/ui/fl/initial/_internal/ManifestUtils","sap/ui/fl/initial/_internal/Settings","sap/ui/fl/initial/_internal/Storage","sap/ui/fl/initial/_internal/StorageUtils"],function(e,t,a,n,r,i,s,o,c,l){"use strict";const d={};const f={};const p={};function u(e){if(typeof e==="string"){e={id:e}}e.idIsLocal=true;return e}function m(e,t){if(s.getOvpEntry(e)){[t.changes,t.variantChanges,t.variantDependentControlChanges,t.variantManagementChanges].flat().filter(e=>e.selector&&!e.selector.idIsLocal).forEach(function(e){e.selector=u(e.selector);if(e.dependentSelector){Object.keys(e.dependentSelector).forEach(t=>{const a=e.dependentSelector[t];if(Array.isArray(a)){e.dependentSelector[t]=a.map(u)}else{e.dependentSelector[t]=u(a)}})}})}return t}function h(e){l.getAllFlexObjectNamespaces().forEach(function(a){const n=t.get(a,e);if(n){t.set(a,n.filter(e=>{let t;try{t=new r(e.fileName)}catch(e){return false}t.destroy();return true}),e)}});return e}function g(e){if(e?.startupParameters&&Array.isArray(e.startupParameters.hcpApplicationId)){return e.startupParameters.hcpApplicationId[0]}}function y(e){const a="deactivateChanges";const n=e.changes.map(e=>{if(e.changeType===a){return[e.fileName,...e.content.changeIds]}}).flat().filter(Boolean);if(n.length){l.getAllFlexObjectNamespaces().forEach(function(a){const r=t.get(a,e);if(r.length){t.set(a,r.filter(e=>!n.includes(e.fileName)),e)}})}return e}p.getFlexData=async function(t){const n=t.reference||s.getFlexReference(t);let r=i.getByReference(n);const p=r.version;const u=r.displayedAdaptationId;const v=r.allContextsProvided;const C=f[n];const F=new e;f[n]=F;if(C){await C.promise}const b=t.reInitialize||!d[n]||d[n].parameters.emptyState||d[n].parameters.version!==p||d[n].parameters.allContextsProvided!==v||d[n].parameters.adaptationId!==u;const x=d[n]&&!d[n].parameters.emptyState&&d[n].parameters.bundleNotLoaded&&!t.skipLoadBundle;if(!b&&!x){F.resolve();return d[n]}let I;let w;let S=false;const A=s.getBaseComponentNameFromManifest(t.manifest);if(b){S=d[n]&&l.isStorageResponseFilled(d[n].data.changes);const e=t.reInitialize?undefined:s.getCacheKeyFromAsyncHints(n,t.asyncHints);I=await c.loadFlexData({preview:s.getPreviewSectionFromAsyncHints(t.asyncHints),reference:n,componentName:A,cacheKey:e,siteId:g(t.componentData),appDescriptor:t.manifest.getRawJson?t.manifest.getRawJson():t.manifest,version:p,adaptationId:u,skipLoadBundle:t.skipLoadBundle});const a=await o.getInstance();w=a.getIsVariantAuthorNameAvailable()?await c.loadVariantsAuthors(n):{}}else{S=d[n].parameters.previouslyFilledData;I=await c.completeFlexData({reference:n,componentName:A,partialFlexData:d[n].data.changes});w=d[n].data.authors}const D=Object.assign({},I);y(D);h(D);m(t.manifest,D);const L={changes:D,cacheKey:D.cacheKey,authors:w};d[n]={data:L,parameters:{bundleNotLoaded:!!t.skipLoadBundle,version:p,allContextsProvided:v,adaptationId:u,loaderCacheKey:a(),previouslyFilledData:S}};if(L.changes.info!==undefined){r={...r,...L.changes.info}}i.setByReference(r,n);F.resolve();return d[n]};p.initializeEmptyCache=function(e){const t={changes:l.getEmptyFlexDataResponse()};d[e]={data:t,parameters:{bundleNotLoaded:true,emptyState:true,loaderCacheKey:a()}};return d[e]};p.clearCache=function(e){if(e){delete d[e];delete f[e]}else{Object.keys(d).forEach(e=>{delete d[e];delete f[e]})}};p.loadFlVariant=async function(e){const t=await c.loadFlVariant({variantReference:e.variantReference,reference:e.reference});Object.entries(t).forEach(([t,a])=>{d[e.reference].data.changes[t].push(...a)});d[e.reference].parameters.loaderCacheKey=a();return{newData:t,completeLoaderData:d[e.reference]}};p.updateCachedResponse=function(e,t){l.updateStorageResponse(d[e].data,t);d[e].parameters.loaderCacheKey=a();return d[e].parameters.loaderCacheKey};p.getCachedFlexData=function(e){return d[e]?.data||{}};p.waitForInitialization=function(e){const t=f[e]?.promise;if(!t){n.error("Loader.waitForInitialization was called before FlexState.initialize");return Promise.resolve()}return t};p.setAllContextsProvided=function(e,t){if(d[e]&&d[e].parameters.allContextsProvided===undefined){d[e].parameters.allContextsProvided=t}};return p});
//# sourceMappingURL=Loader.js.map