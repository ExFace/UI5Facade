/*!
 * OpenUI5
 * (c) Copyright 2026 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/core/Component","sap/ui/core/Lib","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/fl/initial/_internal/Loader","sap/ui/fl/initial/_internal/ManifestUtils","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/variants/VariantModel","sap/ui/fl/Layer","sap/ui/fl/requireAsync","sap/ui/fl/Utils","sap/ui/model/json/JSONModel","sap/ui/model/odata/ODataUtils"],function(t,e,n,a,o,i,s,r,c,l,p,d,f){"use strict";const g={};g._componentInstantiationPromises=new WeakMap;g._embeddedComponents={};function m(t){return s.isStorageResponseFilled(t.data.changes)||t.parameters.previouslyFilledData}async function u(t,e){if(m(e)){const e=await l("sap/ui/fl/apply/_internal/flexState/FlexState");await e.initialize(t)}}async function y(e){if(p.getUshellContainer()){return}const a=window.sessionStorage.getItem(`sap.ui.rta.restart.${c.CUSTOMER}`);if(a){const o=i.getFlexReferenceForControl(e);if(a!==o&&a!=="true"){t.error(`an application component was started which does not match the component for which the restart was triggered:\n\t\t\t\t\tTriggering component: ${a}\n\t\t\t\t\tStarted component: ${o}`);return}await Promise.all([n.load({name:"sap.ui.rta"}),e.rootControlLoaded()]);const s=await l("sap/ui/rta/api/startKeyUserAdaptation");s({rootControl:e})}}function w(t,e){if(e.messagebundle&&!t.getModel("i18nFlexVendor")&&e?.changes?.some(t=>t.layer===c.VENDOR)){t.setModel(new d(e.messagebundle),"i18nFlexVendor")}}async function h(t,e){const n=await l("sap/ui/fl/apply/_internal/changes/Applier");const a=n.applyAllChangesForControl.bind(n,t,e);a._bIsFlexApplyChangesFunction=true;t.addPropagationListener(a)}async function C(t,e){const n=i.getFlexReferenceForControl(t);const s=await o.getFlexData({componentData:t.getComponentData(),asyncHints:e.asyncHints,manifest:t.getManifestObject(),reference:n});const r=t.getId();if(m(s)){const a=await l("sap/ui/fl/apply/_internal/flexState/FlexState");await a.initialize({componentId:r,asyncHints:e.asyncHints});await h(t,n);w(t,s.data.changes)}const c=g._createVariantModel(t);await c.initialize();t.setModel(c,a.getVariantModelName());if(g._embeddedComponents[r]){g._embeddedComponents[r].forEach(function(e){const n=t.getModel(a.getVariantModelName());e.setModel(n,a.getVariantModelName())});delete g._embeddedComponents[r]}await y(t)}g._createVariantModel=function(t){return new r({},{appComponent:t})};g.instanceCreatedHook=async function(t,e){if(p.isApplicationComponent(t)){const n=await C(t,e);g._componentInstantiationPromises.set(t,n);return n}else if(p.isEmbeddedComponent(t)){const e=p.getAppComponentForControl(t);if(g._componentInstantiationPromises.has(e)){await g._componentInstantiationPromises.get(e);const n=e.getModel(a.getVariantModelName());t.setModel(n,a.getVariantModelName())}g._embeddedComponents[e.getId()]||=[];g._embeddedComponents[e.getId()].push(t)}return undefined};g.componentLoadedHook=async function(t,e){if(p.isApplication(e)&&t.id){const n={manifest:e,componentData:t.componentData||t.settings?.componentData,asyncHints:t.asyncHints};const a=await o.getFlexData(n);await u({...n,componentId:t.id},a);const i="$sap.ui.fl.changes";const s=e?.getEntry?.(i)?.descriptor||[];if(s.length){const t=e.getJson();const n=await l("sap/ui/fl/apply/_internal/changes/descriptor/Applier");await n.applyInlineChanges(t,s);delete t[i]}}};async function M(n){const a=n.owner&&e.get(n.owner.id);if(!n.factoryConfig){t.error("Could not fetch Annotation changes. This can be caused by creating a component in an unsupported way");return[]}const s=a?.getManifest()||n.manifest;if(!p.isApplication(s)){return[]}const r=n.owner?.id||n.factoryConfig.id||n.factoryConfig.settings?.id;const c=a?.getComponentData()||n.factoryConfig.componentData||n.factoryConfig.settings?.componentData;const d=i.getFlexReference({manifest:s,componentData:c});try{const e={componentData:c,asyncHints:n.owner?.config.asyncHints||n.factoryConfig.asyncHints,componentId:r,reference:d,skipLoadBundle:true,manifest:s};const a=await o.getFlexData(e);if(!m(a)){return[]}const i=await l("sap/ui/fl/apply/_internal/flexState/FlexState");await i.initialize(e);const p=f.removeOriginSegmentParameters(n.model.getServiceUrl());const g=i.getAnnotationChanges(d).filter(t=>t.getServiceUrl()===p);return g.reduce(async(e,n)=>{const a=await e;try{const t=await l("sap/ui/fl/apply/_internal/changeHandlers/ChangeHandlerRegistration");const e=await t.getAnnotationChangeHandler({changeType:n.getChangeType()});a.push(await e.applyChange(n));n._appliedOnModel=true}catch(e){t.error(`Annotation change with id ${n.getId()} could not be applied to the model`,e)}return a},Promise.resolve([]))}catch(e){t.error("Annotation changes could not be applied.",e);return[]}}g.modelCreatedHook=function(t){t.model.setAnnotationChangePromise(M(t))};g.preprocessManifest=async function(t,e){if(!p.isApplication(t,true)||!e.id){return t}const n=e.componentData||{};const a=i.getFlexReference({manifest:t,componentData:n});const s=await o.getFlexData({componentData:e.componentData||e.settings?.componentData,asyncHints:e.asyncHints,manifest:t,skipLoadBundle:true});if(m(s)){await u({...e,rawManifest:t,componentId:e.id,reference:a,skipLoadBundle:true},s);const n={...t};const o=await l("sap/ui/fl/apply/_internal/changes/descriptor/Applier");return o.applyChanges(n)}return t};return g});
//# sourceMappingURL=ComponentLifecycleHooks.js.map