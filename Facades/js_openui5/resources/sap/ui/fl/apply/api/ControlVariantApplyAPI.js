/*!
 * OpenUI5
 * (c) Copyright 2026 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/core/Element","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagerApply","sap/ui/fl/apply/_internal/flexState/FlexObjectState","sap/ui/fl/initial/_internal/ManifestUtils","sap/ui/fl/Utils","sap/ui/fl/apply/_internal/init"],function(e,t,n,a,r,o,i,l,c,s,f){"use strict";var p="$FlexVariants";function d(e){var t=e.getModel(p);if(t){return Promise.resolve(t)}return new Promise(function(n){function a(){t=e.getModel(p);if(t){e.detachModelContextChange(a);n(t)}}e.attachModelContextChange(a)})}function m(e,t,n){const a=i.getVariantChangesForVariant({vmReference:e,reference:n});const r=i.getDefaultVariantReference({vmReference:e,reference:n});if(t.getExecuteOnSelectionForStandardDefault()&&r===e&&!a.some(e=>e.getChangeType()==="setExecuteOnSelect")){const t=i.getVariant({vmReference:e,reference:n,vReference:e});t.instance.setExecuteOnSelection(true);i.updateVariant({reference:n,variant:t.instance});return true}return false}function g(e){const n=i.getInitialUIChanges({vmReference:e.vmReference,reference:e.reference});const a=n.reduce((n,a)=>{const r=a.getSelector();const o=t.bySelector(r,e.appComponent);if(o&&f.indexOfObject(n,{selector:o})===-1){n.push({selector:o})}return n},[]);return a.length?c.waitForFlexObjectsToBeApplied(a,e.appComponent):Promise.resolve()}function u(e){return new Promise(t=>{if(e.getDomRef()){t()}else{e.addEventDelegate({onAfterRendering(){t()}})}})}var V={getVariantModelName(){return p},getVariantModel(e){return d(e)},getVariantManagementControlByVMReference(e,t){return o.getVariantManagementControlByVMReference(e,t)},clearVariantParameterInURL(t){var n;var a=f.getAppComponentForControl(t.control);var o=a&&a.getModel(p);if(!o){e.error("Variant model could not be found on the provided control");return}if(t.control.isA("sap.ui.fl.variants.VariantManagement")){var i=o.getLocalId(t.control.getId(),a);var l=r.removeURLParameterForVariantManagement({model:o,vmReference:i});n=l.parameters}r.update({parameters:n||[],updateURL:true,updateHashEntry:!!o,model:o||{},silent:!o})},async activateVariant(t){function r(t){e.error(t);throw t}let o;if(typeof t.element==="string"){o=n.getComponentById(t.element);if(!(o instanceof n)){o=a.getElementById(t.element);if(!(o instanceof a)){r(Error("No valid component or control found for the provided ID"))}}}else if(t.element instanceof n||t.element instanceof a){o=t.element}const c=f.getAppComponentForControl(o);const p=s.getFlexReferenceForControl(o);if(!c){r(Error("A valid variant management control or component (instance or ID) should be passed as parameter"))}if(t.standardVariant&&!o.isA("sap.ui.fl.variants.VariantManagement")){r(Error("With using standardVariant and no variantReference, a variant management control must be passed as element"))}let d;let m;let g;if(t.standardVariant){d=o.getVariantManagementReference();m=d;g=o}else{d=i.getVariantManagementReferenceForVariant(p,t.variantReference);m=t.variantReference;if(!d){try{await i.loadVariant({reference:p,variantReference:m,componentId:c.getId()});d=i.getVariantManagementReferenceForVariant(p,t.variantReference)}catch(e){r(Error(`Variant with reference '${m}' could not be found`))}if(!d){r(Error("Variant management reference not found. Check the passed element and variantReference"))}}g=this.getVariantManagementControlByVMReference(d,c)}await g.waitForInit();try{await l.updateCurrentVariant({newVariantReference:m,appComponent:c,vmControl:g})}catch(e){r(e)}},async attachVariantApplied(t){const n=a.getElementById(t.vmControlId);await n.waitForInit();const r=t.selector.id&&a.getElementById(t.selector.id)||t.selector;const l=f.getAppComponentForControl(r);const c=n.getVariantManagementReference();const p=s.getFlexReferenceForControl(n);const d=m(c,n,p);if(t.callAfterInitialVariant||d){g({appComponent:l,reference:p,vmReference:c}).then(()=>{const e=i.getCurrentVariantReference({vmReference:c,reference:p});const n=i.getVariant({vmReference:c,reference:p,vReference:e});t.callback(n)})}await u(r);if(o.getRelevantVariantManagementControlId(r)===t.vmControlId){n.setShowExecuteOnSelection(true);n._addVariantAppliedListener(r,t.callback)}else{e.error("Error in attachVariantApplied: The passed VariantManagement ID doesn't match the responsible VariantManagement control")}},async detachVariantApplied(e){const t=a.getElementById(e.vmControlId);const n=e.selector.id&&a.getElementById(e.selector.id)||e.selector;await Promise.all([t.waitForInit(),u(n)]);t._removeVariantAppliedListener(n)}};return V});
//# sourceMappingURL=ControlVariantApplyAPI.js.map