/*!
 * OpenUI5
 * (c) Copyright 2026 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/FlexObjectState","sap/ui/fl/initial/_internal/ManifestUtils","sap/ui/fl/requireAsync","sap/ui/fl/Utils"],function(e,n,t,r,a,i,c,o,s){"use strict";const p={};function f(e){const n=a.getControlChangesForVariant({vmReference:e.vmReference,reference:e.reference,vReference:e.currentVReference});const t=a.getControlChangesForVariant({vmReference:e.vmReference,reference:e.reference,vReference:e.newVReference});const r=n.findIndex((e,n)=>{const r=t[n];return!r||e.getId()!==r.getId()});const i=r>=0?r:n.length;return{changesToBeReverted:n.slice(i).reverse(),changesToBeApplied:t.slice(i)}}async function l(e){const c=f(e);const o=i.getLiveDependencyMap(e.reference);c.changesToBeReverted.forEach(e=>e.setQueuedForRevert());c.changesToBeApplied.forEach(n=>{if(!n.isApplyProcessFinished()){n.setQueuedForApply();r.addRuntimeChangeToMap(n,e.appComponent,o)}});if(c.changesToBeReverted.length>0){await t.revertMultipleChanges(c.changesToBeReverted,{...e,skipSetQueued:true})}if(c.changesToBeApplied.length>0){await n.applyMultipleChanges(c.changesToBeApplied,{...e,skipSetQueued:true})}a.setCurrentVariant(e)}p.executeAfterSwitch=function(e,n,t){const r=a.waitForVariantSwitch(n,t).catch(function(){}).then(e);a.setVariantSwitchPromise(n,t,r);return r};p.updateCurrentVariant=function(n){const t=n.vmControl.getVariantManagementReference();const r=n.appComponent||s.getAppComponentForControl(n.vmControl);const i=c.getFlexReferenceForControl(r);const o=async()=>{const c=a.getVariant({reference:i,vmReference:t,vReference:n.newVariantReference});if(n.scenario){c.createScenario=n.scenario}const o=n.vmControl.getCurrentVariantReference();if(o!==n.newVariantReference){await l({vmReference:t,currentVReference:o,newVReference:n.newVariantReference,appComponent:r,modifier:e,reference:i})}n.vmControl._executeAllVariantAppliedListeners(c)};if(n.skipExecuteAfterSwitch){return o()}return p.executeAfterSwitch(o,i,t)};p.handleSelectVariant=async function(e,n){const t=s.getAppComponentForControl(n);const r=n.getVariantManagementReference();const a=n.getModified();const i=e.getParameter("key");const c=n.getCurrentVariantReference();const f=c!==i;await p.updateCurrentVariant({newVariantReference:i,appComponent:t,vmControl:n,skipExecuteAfterSwitch:true});if(a){const e=await o("sap/ui/fl/variants/VariantManager");await e.eraseDirtyChangesOnVariant(r,c,n,!f)}};return p});
//# sourceMappingURL=VariantManagerApply.js.map