/*!
 * OpenUI5
 * (c) Copyright 2026 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/Deferred","sap/base/util/each","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/Component","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/flexState/DataSelector","sap/ui/fl/apply/_internal/flexState/InitialPrepareFunctions","sap/ui/fl/initial/_internal/Loader","sap/ui/fl/initial/_internal/ManifestUtils","sap/ui/fl/initial/_internal/FlexInfoSession","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/LayerUtils","sap/ui/fl/apply/_internal/init"],function(e,t,n,a,r,c,i,s,o,l,f,u,p,d,m,g,h){"use strict";const b="sap.ui.fl.apply._internal.flexObjects.AppDescriptorChange";const x="sap.ui.fl.apply._internal.flexObjects.AnnotationChange";const y={};const O={};const j={};const F={appDescriptorChanges:{pathInResponse:[]},annotationChanges:{pathInResponse:[]},changes:{initialPreparationFunctionName:"uiChanges",pathInResponse:["changes"]},variants:{initialPreparationFunctionName:"variants",pathInResponse:["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"]},comp:{pathInResponse:["comp.changes","comp.defaultVariants","comp.standardVariants","comp.variants"]}};const R={flexObjects:{},smartVariantManagementControls:{}};function I(e,t){var n={comp(){return Object.values(t).reduce(function(e,t){return e.concat(t)},[])},variants(){return t.map(function(e){var n=e.variantReference===e.variantManagementReference||t.some(function(t){return t.variantManagementReference===e.variantManagementReference&&t.fileName===e.variantReference});if(!n){return{...e,variantReference:e.variantManagementReference}}return e})}}[e];if(n){return n()}return Array.isArray(t)?t:[]}function v(e){var t=i.getComponentById(e.componentId);e.componentData||=t&&t.getComponentData()||{};e.manifest||=e.rawManifest||t&&t.getManifestObject()||{};e.reference||=d.getFlexReference(e)}function C(e){var t=[];n(e.changes,function(e,n){I(e,n).forEach(function(e){t.push(s.createFromFileContent(e,null,true))})});return t}function D(e,t){var n=F[e].initialPreparationFunctionName;var a=u[n];if(a){return a(t)}return undefined}var S=new f({id:"flexObjects",parameterKey:"reference",executeFunction(e,t){if(!O[t.reference]){return[]}var n=O[t.reference].runtimePersistence;return n.flexObjects.concat(n.runtimeOnlyData.flexObjects||[],R.flexObjects[t.reference][O[t.reference].componentId]||[])}});const P=new f({id:"appDescriptorChanges",parentDataSelector:S,executeFunction(e){return e.filter(e=>e.isA(b))},checkInvalidation(e,t){const n=["addFlexObject","removeFlexObject"].includes(t.type);return n&&t.updatedObject?.isA(b)}});const w=new f({id:"annotationChanges",parentDataSelector:S,executeFunction(e){return e.filter(e=>e.isA(x))},checkInvalidation(e,t){const n=["addFlexObject","removeFlexObject"].includes(t.type);return n&&t.updatedObject?.isA(x)}});function E(e,t){const n=e.storageResponse;var r={flexObjects:C(n),runtimeOnlyData:{liveDependencyMap:l.createEmptyDependencyMap(),flexObjects:[]}};if(!e.componentId){return r}Object.keys(F).forEach(function(c){var i=D(c,{storageResponse:n,externalData:t,flexObjects:r.flexObjects,componentId:e.componentId});if(i){r=a(r,i)}});return r}function L(e,t,a){const r=a.flexObjects.slice();const i=r.length;const l=[];let f;n(t.changes,function(e,t){I(e,t).forEach(function(e){l.push(e)})});O[e].runtimePersistence={...a,flexObjects:l.map(function(e){let t;const n=r.find(function(n,a){t=a;return n.getId()===e.fileName});if(n){r.splice(t,1);if(n.getState()!==o.LifecycleState.PERSISTED){n.setResponse(e);f=true}return n}if(e.fileType==="ctrl_variant_change"&&e.fileName.endsWith("flVariant_contextFiltering_setVisible")){return s.createFromFileContent(e,null,true)}const a="Error updating runtime persistence: storage returned unknown flex objects";c.error(a);throw new Error(a)})};if(i!==O[e].runtimePersistence.flexObjects.length){f=true}return f}function k(e,t){var n=e.reference;var a=false;if(!O[n].componentData&&e.componentId){var c=i.getComponentById(e.componentId);O[n].componentData=c?c.getComponentData():e.componentData;a=true}if(!O[n].storageResponse){O[n].storageResponse=_(n,t);delete O[n].runtimePersistence;a=true}if(!r.get(["flexObjects",n,e.componentId],R)){r.set(["flexObjects",n,e.componentId],[],R)}if(!O[n].runtimePersistence){O[n].runtimePersistence=E(O[n],R.flexObjects[n][e.componentId]||[]);a=true}if(a){S.checkUpdate({reference:n})}}function _(e,t){const c=a({},t);c.changes={...g.getEmptyFlexDataResponse(),...c.changes};const i=c.changes;const s=m.getByReference(e);if(h.isLayerFilteringRequired(e)){n(F,function(e,t){t.pathInResponse.forEach(function(e){const t=r.get(e,i).filter(function(e){return!e.layer||!h.isOverLayer(e.layer,s.maxLayer)});r.set(e,t,i)})})}O[e].maxLayer=s.maxLayer;return c}function M(e,t){O[e.reference]=a({},{componentId:e.componentId,componentData:e.componentData,skipLoadBundle:e.skipLoadBundle,loaderCacheKey:t})}function z(e){var t=O[e.reference].componentId;return t!==e.componentId}function U(e,t){if(O[e]?.maxLayer!==m.getByReference(e).maxLayer){y.rebuildFilteredResponse(e,t)}}function V(e,n){if(!n){throw new Error(`No FlexState instance created for reference ${e} - missing component ID`)}if(O[e]?.componentId===n){return}O[e]={emptyState:true,reInitialize:true,componentId:n};const a=new t;j[e]=a;a.resolve();const r=p.initializeEmptyCache(e);k({reference:e},r)}y.getRuntimeOnlyData=function(e){return O[e]?.runtimePersistence?.runtimeOnlyData};y.addFlexObjectsToRuntimeOnlyData=function(e,t,n){V(e,t);O[e].runtimePersistence.runtimeOnlyData.flexObjects.push(...n)};y.initialize=async function(e){const n=a({},e);v(n);const r=n.reference;const c=j[r];const i=new t;j[r]=i;if(c){await c.promise}const s=await p.getFlexData(n);if(!O[n.reference]?.storageResponse||s.parameters.loaderCacheKey!==O[n.reference].loaderCacheKey||z(n)){M(n,s.parameters.loaderCacheKey)}else{U(n.reference,s.data)}k(n,s.data);i.resolve()};y.waitForInitialization=function(e){const t=j[e]?.promise;if(!t){c.error("FlexState.waitForInitialization was called before FlexState.initialize");return Promise.resolve()}return t};y.isInitialized=function(e){var t=e.reference?e.reference:d.getFlexReferenceForControl(e.control);return!!O[t]};y.lazyLoadFlVariant=async function(e){V(e.reference,e.componentId);const t=await p.loadFlVariant(e);const n=O[e.reference];n.loaderCacheKey=t.completeLoaderData.parameters.loaderCacheKey;n.storageResponse=_(e.reference,t.completeLoaderData.data);n.runtimePersistence.flexObjects=[...n.runtimePersistence.flexObjects,...C(_(e.reference,{changes:t.newData}))];S.checkUpdate({reference:e.reference})};y.reinitialize=async function(e){v(e);const n=e.reference;const a=j[n];const r=new t;j[n]=r;if(a){await a.promise}e.reInitialize=true;const c=await p.getFlexData(e);if(!O[n]){M(e,c.parameters.loaderCacheKey);k(e,c.data)}else{const t=O[n].runtimePersistence;M(e,c.parameters.loaderCacheKey);O[n].storageResponse=_(n,c.data);const a=L(n,O[n].storageResponse,t);if(a){S.checkUpdate({reference:n})}}r.resolve()};y.update=function(e,t){const n=[];g.updateStorageResponse(O[e].storageResponse,t);const a=p.updateCachedResponse(e,t);O[e].loaderCacheKey=a;t.forEach(t=>{if(t.type!=="ui2"){const a=O[e].runtimePersistence.flexObjects.findIndex(e=>e.getId()===t.flexObject.fileName);const r=O[e].runtimePersistence.flexObjects[a];switch(t.type){case"add":if(a<0){throw new Error("Flex response includes unknown flex object")}break;case"delete":if(a>=0){O[e].runtimePersistence.flexObjects.splice(a,1);n.push({type:"removeFlexObject",updatedObject:r})}break;case"update":if(r&&r.getState()!==o.LifecycleState.PERSISTED){r.setResponse(t.flexObject);n.push({type:"updateFlexObject",updatedObject:r})}break;default:}}});if(n.length){S.checkUpdate({reference:e},n)}};y.clearState=function(e){p.clearCache(e);if(e){delete O[e];delete j[e];S.clearCachedResult({reference:e})}else{Object.keys(O).forEach(e=>delete O[e]);Object.keys(j).forEach(e=>delete j[e]);S.clearCachedResult()}};y.addRuntimeSteadyObject=function(e,t,n){V(e,t);n.setState(o.LifecycleState.PERSISTED);R.flexObjects[e]||={};R.flexObjects[e][t]||=[];R.flexObjects[e][t].push(n);S.checkUpdate({reference:e},[{type:"addFlexObject",updatedObject:n}])};y.clearRuntimeSteadyObjects=function(e,t){if(R.flexObjects[e]){delete R.flexObjects[e][t];S.clearCachedResult({reference:e})}};y.rebuildFilteredResponse=function(e,t){if(O[e]){O[e].storageResponse=_(e,t);O[e].runtimePersistence=E(O[e],R.flexObjects[e][O[e].componentId]||[]);S.checkUpdate({reference:e})}};y.addDirtyFlexObjects=function(e,t,n){if(n){V(e,n)}const a=m.getByReference(e).adaptationLayer;const r=t.filter(e=>!a||!h.isOverLayer(e.getLayer(),a)).filter(t=>!O[e].runtimePersistence.flexObjects.some(e=>e.getId()===t.getId()));if(r.length>0){O[e].runtimePersistence.flexObjects=O[e].runtimePersistence.flexObjects.concat(r);S.checkUpdate({reference:e},r.map(function(e){return{type:"addFlexObject",updatedObject:e}}))}return r};y.removeDirtyFlexObjects=function(e,t){const n=[];if(t.length>0){const a=O[e].runtimePersistence.flexObjects;t.forEach(function(e){const t=a.indexOf(e);if(t>=0){n.push(e);a.splice(t,1)}});if(n.length>0){S.checkUpdate({reference:e},t.map(function(e){return{type:"removeFlexObject",updatedObject:e}}))}}return n};y.getComponentIdForReference=function(e){return O[e]?.componentId};y.getFlexObjectsDataSelector=function(){return S};y.getAppDescriptorChanges=function(e){return P.get({reference:e})};y.getAnnotationChanges=function(e){return w.get({reference:e})};y.getUI2Personalization=function(e){return a({},O[e].storageResponse.changes.ui2personalization)};y.callPrepareFunction=function(e,t){return F[e].prepareFunction(t)};y.getStorageResponse=async function(e){if(j[e]){await j[e].promise;return p.getCachedFlexData(e)}return undefined};y.getComponentData=function(e){return O[e]&&O[e].componentData};y.addSVMControl=function(e,t){R.smartVariantManagementControls[e]||=[];R.smartVariantManagementControls[e].push(t)};y.getSVMControls=function(e){return R.smartVariantManagementControls[e]||[]};return y});
//# sourceMappingURL=FlexState.js.map