/*
 * ! OpenUI5
 * (c) Copyright 2026 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_difference","sap/base/util/merge","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Element","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagerApply","sap/ui/fl/apply/_internal/flexState/FlexObjectState","sap/ui/fl/apply/api/FlexRuntimeInfoAPI","sap/ui/fl/initial/_internal/ManifestUtils","sap/ui/fl/initial/_internal/Settings","sap/ui/fl/write/_internal/controlVariants/ControlVariantWriteUtils","sap/ui/fl/write/_internal/flexState/changes/UIChangeManager","sap/ui/fl/write/_internal/flexState/FlexObjectManager","sap/ui/fl/write/api/ContextBasedAdaptationsAPI","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Utils"],function(e,n,t,a,r,c,o,i,s,l,f,p,g,u,m,d,v,C,y,R,h){"use strict";var V={};function x(e){return e.getModel("$FlexVariants")}function F(e,n){const t=e.map(e=>e.getId());return f.getDirtyFlexObjects(n).filter(function(e){return t.includes(e.getId())&&!e.getSavedToVariant()})}function I(e,n,t){const a=e.getVariantManagementReference();const r=g.getFlexReferenceForControl(e);const c=s.getVariantsForVariantManagement({reference:r,vmReference:a});const o=s.getDefaultVariantReference({reference:r,vmReference:a});const i=[];const l=u.getInstanceOrUndef();const f=[];const p=e=>c.find(n=>n.key===e);const m=(e,t,a)=>{const r=["setTitle","setExecuteOnSelect","setVisible"].includes(t);const c=r&&l?.getIsPublicFlVariantEnabled()&&e.layer===y.PUBLIC?y.PUBLIC:n;i.push({variantReference:e.key,changeType:t,layer:c,...a})};t.getParameter("renamed")?.forEach(({key:e,name:n})=>{const t=p(e);m(t,"setTitle",{title:n,originalTitle:t.title})});t.getParameter("fav")?.forEach(({key:e,visible:n})=>{const t=p(e);m(t,"setFavorite",{favorite:n,originalFavorite:t.favorite})});t.getParameter("exe")?.forEach(({key:e,exe:n})=>{const t=p(e);m(t,"setExecuteOnSelect",{executeOnSelect:n,originalExecuteOnSelect:t.executeOnSelect})});t.getParameter("deleted")?.forEach(e=>{const n=p(e);m(n,"setVisible",{visible:false});f.push(e)});t.getParameter("contexts")?.forEach(({key:e,contexts:n})=>{const t=p(e);m(t,"setContexts",{contexts:n,originalContexts:t.contexts})});const d=t.getParameter("def");if(d){i.push({variantManagementReference:a,changeType:"setDefault",defaultVariant:d,originalDefaultVariant:o,layer:n})}return{changes:i,variantsToBeDeleted:f}}async function M(e){const n=F(e.changes,e.reference).slice().reverse();if(n.length>0){if(e.revert){await c.revertMultipleChanges(n,{appComponent:e.appComponent,modifier:t,reference:e.reference})}v.deleteFlexObjects({reference:e.reference,flexObjects:n})}}async function O(e){const{dirtyChanges:n,variantManagementReference:t,appComponent:a,variantManagementControl:r,flexReference:c}=e;if(!r.getDesignMode()){const e=await v.saveFlexObjects({flexObjects:n,selector:a});if(e){const n=e.response.find(e=>e.fileType==="ctrl_variant");const a=s.getVariantsForVariantManagement({reference:c,vmReference:t});const r=a.find(e=>e.key===n.fileName);const o=r.instance.getSupportInformation();o.user=n.support.user;r.instance.setSupportInformation(o)}}}function b(e,n,t){var a={layer:e,control:n,reference:t};var r=C.hasAdaptationsModel(a);return r&&C.getDisplayedAdaptationId(a)}function S(e,n){const t=e.getFlexObjectMetadata().reference;const a={id:n.newVariantReference,variantName:n.title,contexts:n.contexts,layer:n.layer,adaptationId:n.adaptationId,reference:t,generator:n.generator,variantManagementReference:n.variantManagementReference,executeOnSelection:n.executeOnSelection};const r=R.compareAgainstCurrentLayer(e.getLayer(),n.layer);if(r===1){const r=s.getVariant({reference:t,vmReference:n.variantManagementReference,vReference:e.getVariantReference()});if(r.instance.getLayer()===n.layer){a.variantReference=r.instance.getVariantReference()}else{a.variantReference=e.getVariantReference()}}else if(r===0){a.variantReference=e.getVariantReference()}else if(r===-1){a.variantReference=n.sourceVariantId}return o.createFlVariant(a)}function w(e){const t=s.getVariant({reference:e.reference,vmReference:e.variantManagementReference,vReference:e.sourceVariantId});const a=s.getControlChangesForVariant({vmReference:e.variantManagementReference,vReference:e.sourceVariantId,reference:e.reference}).map(e=>e.convertToFileContent());const r=S(t.instance,{...e});return{instance:r,variantChanges:{},controlChanges:a.reduce((t,a)=>{if(R.compareAgainstCurrentLayer(a.layer,e.layer)>=0){const c=n({},a);c.layer=e.layer;c.variantReference=r.getId();c.support||={};c.support.sourceChangeFileName=a.fileName;c.packageName="$TMP";c.fileName=h.createDefaultFileName(c.changeType);t.push(o.createFromFileContent(c))}return t},[])}}async function T(e){const n=x(e.appComponent);const t=w({...e});t.generator=e.generator;n.oData[e.variantManagementReference].variants.push({key:t.instance.getId(),rename:true,change:true,remove:true,sharing:e.layer===y.USER?n.sharing.PRIVATE:n.sharing.PUBLIC});const a=[];if(e.layer===y.PUBLIC){t.instance.setFavorite(false);const n={variantId:e.newVariantReference,changeType:"setFavorite",fileType:"ctrl_variant_change",generator:e.generator,layer:y.USER,reference:e.reference,content:{favorite:true}};a.push(o.createVariantChange(n))}const r=v.addDirtyFlexObjects(e.reference,e.appComponent.getId(),a.concat([t.instance].concat(t.controlChanges).concat(e.additionalVariantChanges)));await l.updateCurrentVariant({variantManagementReference:e.variantManagementReference,newVariantReference:t.instance.getId(),appComponent:e.appComponent,vmControl:e.vmControl,skipExecuteAfterSwitch:true,scenario:"saveAs"});return r}V.handleManageEvent=async function(n,t){const a=t.getVariantManagementReference();const r=h.getAppComponentForControl(t);const c=g.getFlexReferenceForControl(r);const{changes:o,variantsToBeDeleted:f}=I(t,y.USER,n);if(!o.length&&!f.length){return}if(o.some(e=>e.visible===false&&e.variantReference===t.getCurrentVariantReference())){const e=n.getParameter("def")||s.getDefaultVariantReference({reference:c,vmReference:a});await l.updateCurrentVariant({newVariantReference:e,vmControl:t,appComponent:h.getAppComponentForControl(t)})}o.forEach(function(e){e.appComponent=r});const p=V.addVariantChanges(a,o);const u=f.map(e=>{const n=s.getVariant({reference:c,vmReference:a,vReference:e});if(n.layer===y.USER){return m.deleteVariant(c,a,e)}return[]}).flat();const d=[...e(p,u),...u.filter(e=>e.getState()!==i.LifecycleState.NEW)];const C=Object.values(y).reverse();for(const e of C){const n=d.filter(n=>n.getLayer()===e);if(n.length>0){await v.saveFlexObjects({flexObjects:n,selector:r})}}};V.handleSaveEvent=async function(e,a){const r=g.getFlexReferenceForControl(e);const c=h.getAppComponentForControl(e);const i=e.getVariantManagementReference();let f;await l.executeAfterSwitch(async()=>{const l=e.getCurrentVariantReference();const p=s.getControlChangesForVariant({reference:r,vmReference:i,vReference:l});if(a.overwrite){f=F(p,r);const e=s.getVariant({reference:r,vmReference:i,vReference:l});if(e.layer===y.PUBLIC){f.forEach(e=>e.setLayer(y.PUBLIC))}const n=await v.saveFlexObjects({flexObjects:f,selector:c});return n}const g=a.layer||(a.public?y.PUBLIC:y.USER);const u=a.layer||y.USER;const m=a.newVariantReference||h.createDefaultFileName("flVariant");const d={variantManagementReference:i,vmControl:e,appComponent:c,layer:g,title:a.name,contexts:a.contexts,sourceVariantId:l,newVariantReference:m,generator:a.generator,additionalVariantChanges:[],adaptationId:b(u,c,r),executeOnSelection:a.execute,reference:r};const C={content:{},reference:r,generator:d.generator,layer:u,adaptationId:d.adaptationId};if(a.def){const e=n({changeType:"setDefault",content:{defaultVariant:m},fileType:"ctrl_variant_management_change",selector:t.getSelector(i,d.appComponent)},C);d.additionalVariantChanges.push(o.createVariantManagementChange(e))}const R=await T(d);f=R;await M({changes:p,reference:r,vmReference:i,vReference:l,appComponent:c});return O({dirtyChanges:f,variantManagementReference:i,appComponent:c,variantManagementControl:e,flexReference:r})},r,i);return f};V.addAndApplyChangesOnVariant=function(e,n){const c=h.getAppComponentForControl(n);const o=p.getFlexReference({element:c});const i=d.addDirtyChanges(o,e,c);return i.reduce(async function(e,n){await e;const i=a.getElementById(t.getControlIdBySelector(n.getSelector(),c));const s=await r.applyChangeOnControl(n,i,{modifier:t,appComponent:c,view:h.getViewForControl(i)});if(!s.success){const e=s.error||new Error("The change could not be applied.");v.deleteFlexObjects({reference:o,flexObjects:[n]});throw e}},Promise.resolve())};V.eraseDirtyChangesOnVariant=async function(e,n,t,a){const r=p.getFlexReference({element:t});var c=s.getControlChangesForVariant({reference:r,vmReference:e,vReference:n});var o=F(c,r);await M({changes:c,reference:r,vmReference:e,vReference:n,appComponent:h.getAppComponentForControl(t),revert:a===undefined?true:a});return o};V.removeVariant=async function(e){const n=p.getFlexReference({element:e.appComponent});var t=f.getDirtyFlexObjects(n).filter(function(n){return n.getVariantReference&&n.getVariantReference()===e.variant.getId()||n.getId()===e.variant.getId()});await l.updateCurrentVariant({newVariantReference:e.sourceVariantReference,appComponent:e.appComponent,vmControl:e.vmControl});v.deleteFlexObjects({reference:n,flexObjects:t})};V.addVariantChange=function(e,n){const t=V.createVariantChange(e,n);const a=p.getFlexReference({element:n.appComponent});v.addDirtyFlexObjects(a,n.appComponent.getId(),[t]);return t};V.addVariantChanges=function(e,n){const t=n[0].appComponent;const a=p.getFlexReference({element:t});var r=n.map(function(n){return V.createVariantChange(e,n)});v.addDirtyFlexObjects(a,t.getId(),r);return r};V.deleteVariantChange=function(e,n,t){const a=x(n.appComponent);a.setVariantProperties(e,n);v.deleteFlexObjects({reference:a.sFlexReference,flexObjects:[t]})};V.createVariantChange=function(e,n){const a=x(n.appComponent);var r=a.setVariantProperties(e,n);var c={changeType:n.changeType,layer:n.layer,generator:n.generator,reference:a.sFlexReference};if(n.adaptationId!==undefined){c.adaptationId=n.adaptationId}else{c.adaptationId=b(n.layer,n.appComponent,a.sFlexReference)}let i;if(n.changeType==="setDefault"){c.fileType="ctrl_variant_management_change";c.selector=t.getSelector(e,n.appComponent);i=o.createVariantManagementChange(c)}else{c.fileType="ctrl_variant_change";c.variantId=n.variantReference;i=o.createVariantChange(c)}i.setContent(r);if(n.changeType==="setTitle"){i.setText("title",n.title,"XFLD")}return i};V.manageVariants=function(e,n,t,a){function r(t,a){const r=I(e,n,t);a.resolve(r)}return new Promise(function(n){e.attachEventOnce("manage",{resolve:n},r);e.openManagementDialog(true,t,a)})};V.getDirtyChangesFromVariantChanges=function(e,n){return F(e,n)};V.updateVariantManagementMap=function(e){s.getVariantManagementMap().checkUpdate({reference:e})};V.getControlChangesForVariant=function(e,n,t){return s.getVariant({reference:e,vmReference:n,vReference:t}).controlChanges};return V});
//# sourceMappingURL=VariantManager.js.map