/*!
 * OpenUI5
 * (c) Copyright 2026 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_difference","sap/base/util/restricted/_isEqual","sap/base/util/restricted/_omit","sap/base/util/Deferred","sap/base/util/isEmptyObject","sap/base/util/merge","sap/m/library","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Lib","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/FlexObjectState","sap/ui/fl/initial/_internal/ManifestUtils","sap/ui/fl/initial/_internal/Settings","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Utils","sap/ui/model/json/JSONModel","sap/ui/model/BindingMode"],function(e,t,n,a,r,i,s,o,c,l,p,f,u,h,d,g,m,v,y,R,b,V){"use strict";var C={};const{SharingMode:x}=s;function U(e,t){C[e]=t}function S(e){var t=m.getInstanceOrUndef();if(t&&!t.getIsVariantPersonalizationEnabled()){e.remove=false;e.rename=false;e.change=false}}function I(e){var t=m.getInstanceOrUndef();var n=t&&(t.getIsKeyUser()||!t.getUserId()||t.getIsPublicFlVariantEnabled()&&t.getUserId().toUpperCase()===e.instance.getSupportInformation().user.toUpperCase());e.remove=n;e.rename=n;e.change=n}function D(e,t,n){var a=n?y.getCurrentLayer():v.USER;if(e.layer===a&&e.key!==t){return true}return false}function F(){var e=R.getUshellContainer();if(e){var t=[R.getUShellService("UserInfo"),R.getUShellService("URLParsing"),R.getUShellService("Navigation"),R.getUShellService("ShellNavigationInternal")];return Promise.all(t).then(function(e){U("UserInfo",e[0]);U("URLParsing",e[1]);U("Navigation",e[2]);U("ShellNavigationInternal",e[3])}).catch(function(e){throw new Error(`Error getting service from Unified Shell: ${e}`)})}return undefined}function E(e,t){return i({},e.find(function(e){return e.key===t}))}function M(e){const t=h.getInitialUIChanges({vmReference:e.vmReference,reference:e.reference});const n=t.reduce((t,n)=>{const a=n.getSelector();const r=o.bySelector(a,e.appComponent);if(r&&R.indexOfObject(t,{selector:r})===-1){t.push({selector:r})}return t},[]);return n.length?d.waitForFlexObjectsToBeApplied(n,e.appComponent):Promise.resolve()}var O=b.extend("sap.ui.fl.variants.VariantModel",{constructor:function(e,t){this.pSequentialImportCompleted=Promise.resolve();b.apply(this,[e]);this.sharing={PRIVATE:x.Private,PUBLIC:x.Public};this.sFlexReference=g.getFlexReferenceForControl(t.appComponent);this.oAppComponent=t.appComponent;this._oResourceBundle=c.getResourceBundleFor("sap.ui.fl");this.fnUpdateListener=this.updateData.bind(this);this.oDataSelector=h.getVariantManagementMap();this.oDataSelector.addUpdateListener(this.fnUpdateListener);this.updateData();const n=d.getLiveDependencyMap(this.sFlexReference);h.getInitialUIChanges({reference:this.sFlexReference},this.oAppComponent.getId(),this.sFlexReference).forEach(e=>{u.addChangeAndUpdateDependencies(e,this.oAppComponent.getId(),n)});this.setDefaultBindingMode(V.OneWay)}});O.prototype.updateData=function(){const e=this.oDataSelector.get({reference:this.sFlexReference});const t={...this.getData()};Object.entries(e).forEach(e=>{const n=e[0];const a={...e[1]};t[n]||={};t[n].variants=a.variants.map(function(e){const a=(t[n].variants||[]).find(function(t){return t.key===e.key});return{...a||{},...e}});const r=t[n].currentVariant;const i=p.getVariantManagementControlByVMReference(n,this.oAppComponent);if(i&&i.getUpdateVariantInURL()&&r&&r!==a.currentVariant){l.updateVariantInURL({vmReference:n,newVReference:a.currentVariant,model:this})}t[n].currentVariant=a.currentVariant;t[n].defaultVariant=a.defaultVariant;t[n].modified=a.modified});this.setData(t);this.refresh(true)};O.prototype.invalidateMap=function(){this.oDataSelector.checkUpdate({reference:this.sFlexReference})};O.prototype.initialize=function(){return Promise.all([m.getInstance(),F()]).then(function(){l.initialize({model:this})}.bind(this))};O.prototype.getCurrentVariantReference=function(e){return this.oData[e].currentVariant};O.prototype.getVariantManagementReference=function(e){var t="";var n=-1;Object.keys(this.oData).some(function(a){return this.oData[a].variants.some(function(r,i){if(r.key===e){t=a;n=i;return true}return false})}.bind(this));return{variantManagementReference:t,variantIndex:n}};O.prototype.getVariant=function(e,t){var n=t||this.getVariantManagementReference(e).variantManagementReference;return E(this.oData[n].variants,e)};O.prototype.setVariantProperties=function(e,t){var n=this.getData();var a=this.getVariant(t.variantReference,e).instance;const r=p.getVariantManagementControlByVMReference(e,this.oAppComponent);var i={};switch(t.changeType){case"setTitle":a.setName(t.title,true);break;case"setFavorite":i.favorite=t.favorite;a.setFavorite(t.favorite);break;case"setExecuteOnSelect":i.executeOnSelect=t.executeOnSelect;a.setExecuteOnSelection(t.executeOnSelect);break;case"setVisible":i.visible=t.visible;i.createdByReset=false;a.setVisible(t.visible);break;case"setContexts":i.contexts=t.contexts;a.setContexts(t.contexts);break;case"setDefault":i.defaultVariant=t.defaultVariant;var s=l.getStoredHashParams({model:this});if(s&&r.getUpdateVariantInURL()){if(n[e].defaultVariant!==n[e].currentVariant&&s.indexOf(n[e].currentVariant)===-1){l.update({parameters:s.concat(n[e].currentVariant),updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this})}else if(n[e].defaultVariant===n[e].currentVariant&&s.indexOf(n[e].currentVariant)>-1){s.splice(s.indexOf(n[e].currentVariant),1);l.update({parameters:s,updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this})}}break;default:break}return i};O.prototype._ensureStandardVariantExists=function(e){var t=this.getData();var n=t[e]||{};if(!t[e]||r(n)){var a=f.createFlVariant({id:e,variantManagementReference:e,variantName:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),user:p.DEFAULT_AUTHOR,layer:v.BASE,reference:this.sFlexReference});h.addRuntimeSteadyObject(this.sFlexReference,this.oAppComponent.getId(),a);this._aCreatedStandardVariantsFor||=[];this._aCreatedStandardVariantsFor.push(e)}};O.prototype.setModelPropertiesForControl=function(e,t,n){this.oData[e].showFavorites=true;var a=this._bDesignTimeMode;if(a!==t){this._bDesignTimeMode=t;if(t){l.clearAllVariantURLParameters({model:this})}else if(a&&n.getUpdateVariantInURL()){l.update({parameters:l.getStoredHashParams({model:this}),updateURL:true,updateHashEntry:false,model:this})}}if(t&&n.getEditable()){this.oData[e].variantsEditable=false;this.oData[e].variants.forEach(function(n){n.rename=true;n.change=true;n.sharing=this.sharing.PUBLIC;n.remove=D(n,e,t)}.bind(this))}else if(n.getEditable()){this.oData[e].variantsEditable=true;this.oData[e].variants.forEach(function(n){n.remove=D(n,e,t);switch(n.layer){case v.USER:n.rename=true;n.change=true;n.sharing=this.sharing.PRIVATE;S(n);break;case v.PUBLIC:n.sharing=this.sharing.PUBLIC;I(n);break;default:n.rename=false;n.change=false;n.sharing=this.sharing.PUBLIC}}.bind(this))}else{this.oData[e].variantsEditable=false;this.oData[e].variants.forEach(function(e){e.remove=false;e.rename=false;e.change=false})}};O.prototype.getLocalId=function(e,t){return o.getSelector(e,t).id};function L(e,t){this.oData[t].variants.forEach(function(n){const a=n.title&&n.title.match(/{(\w+)>(\w.+)}/);if(a){const[,r,i]=a;const s=e.getModel(r);if(s){const e=s.getResourceBundle().getText(i);const t={reference:this.sFlexReference,changeType:"setTitle",layer:n.layer,fileType:"ctrl_variant_change",variantId:n.key};const a=f.createVariantChange(t);a.setText("title",e,"XFLD");n.instance.setName(e,true);h.addRuntimeSteadyObject(this.sFlexReference,this.oAppComponent.getId(),a)}else{e.attachEventOnce("modelContextChange",L.bind(this,e,t))}}}.bind(this))}O.prototype.registerToModel=function(e){const t=e.getVariantManagementReference();this._ensureStandardVariantExists(t);e.setShowExecuteOnSelection(false);L.call(this,e,t);this.setModelPropertiesForControl(t,false,e);if(e.getUpdateVariantInURL()){l.registerControl({vmReference:t,updateURL:true,model:this});l.handleModelContextChange({model:this,vmControl:e,appComponent:this.oAppComponent})}const n={appComponent:this.oAppComponent,reference:this.sFlexReference,vmReference:t};h.setVariantSwitchPromise(this.sFlexReference,t,M(n))};O.prototype.getCurrentControlVariantIds=function(){return Object.keys(this.oData||{}).reduce(function(e,t){return e.concat([this.oData[t].currentVariant])}.bind(this),[])};O.prototype.getVariantManagementControlIds=function(){var e;return Object.keys(this.oData||{}).reduce(function(t,n){if(this.oAppComponent.byId(n)){e=this.oAppComponent.createId(n)}else{e=n}t.push(e);return t}.bind(this),[])};O.prototype.destroy=function(){const e=this.oDataSelector.get({reference:this.sFlexReference});const t=Object.entries(e).map(([e,t])=>{const n=h.getVariant({vmReference:e,vReference:t.currentVariant,reference:this.sFlexReference});return n.controlChanges}).flat();const n=d.getLiveDependencyMap(this.sFlexReference);const r=[];t.forEach(e=>{if(!e.isPersisted()){r.push(e)}else{u.removeChangeFromMap(n,e.getId());u.removeChangeFromDependencies(n,e.getId())}});this.oDataSelector.removeUpdateListener(this.fnUpdateListener);const i=[];(this._aCreatedStandardVariantsFor||[]).forEach(t=>{if(e[t]?.variants.length>1||e[t]?.variants[0].controlChanges.length){i.push(e[t].variants[0].instance)}});if(i.length){h.addRuntimeOnlyFlexObjects(this.sFlexReference,this.oAppComponent.getId(),i)}h.clearRuntimeSteadyObjects(this.sFlexReference,this.oAppComponent.getId());h.resetCurrentVariantReference(this.sFlexReference);b.prototype.destroy.apply(this);this.oDestroyPromise=new a;if(r.length){sap.ui.require(["sap/ui/fl/write/_internal/flexState/FlexObjectManager"],e=>{e.deleteFlexObjects({reference:this.sFlexReference,flexObjects:r,componentId:this.oAppComponent.getId()});this.oDestroyPromise.resolve()})}else{this.oDestroyPromise.resolve()}};O.prototype.getUShellService=function(e){return R.getUshellContainer()&&C[e]};return O});
//# sourceMappingURL=VariantModel.js.map