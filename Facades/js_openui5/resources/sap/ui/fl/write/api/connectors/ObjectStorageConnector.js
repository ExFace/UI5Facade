/*!
 * OpenUI5
 * (c) Copyright 2026 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/strings/hash","sap/base/util/restricted/_uniqBy","sap/base/util/each","sap/base/util/merge","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/initial/api/Version","sap/ui/fl/write/connectors/BaseConnector","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/apply/_internal/connectors/ObjectStorageUtils","sap/ui/fl/write/_internal/init"],function(e,t,i,n,r,s,a,o,c,f){"use strict";const l={isKeyUser:true,isVariantSharingEnabled:true,isProductiveSystem:false,isCondensingEnabled:true,isContextSharingEnabled:false,isVersioningEnabled:true,logonUser:"DEFAULT_USER",isVariantAuthorNameAvailable:false,isAnnotationChangeEnabled:true,isSeenFeaturesAvailable:false};function u(e){var t=[];return f.forEachObjectInStorage(e,function(e){t.push(e.changeDefinition)}).then(function(){return t})}function d(e,t){var i=true;if(e.selectorIds){if(t.selector){i=e.selectorIds.indexOf(t.selector.id)>-1}else{i=false}}if(i&&e.changeTypes){i=e.changeTypes.indexOf(t.changeType)>-1}return i}function h(e,t){if(!e.creation){var i=Date.now()+t;e.creation=new Date(i).toISOString()}return e}function v(t){return e(t.reduce(function(e,t){return e+new Date(t.creation).getTime()},""))}function g(e,t){i(e,function(e,n){n.forEach(function(e){i(e,function(e,i){t(i,e)})})})}function m(e,t){var i=[];var n=0;g(e,function(e,r){var s=f.createFlexKey(r);var a=t.condensedChanges.find(function(t){return t.getId()===e.fileName});if(!a.getCreation()){var o=Date.now()+n;n++;a.setCreation(new Date(o).toISOString())}i.push({key:s,value:a})});return i}function y(e,t){var i=[];g(e,function(e,n){var r=f.createFlexKey(n);var s;t.some(function(e){if(e.getId()===n){s=e;return true}});i.push({key:r,value:s})});return i}function p(e,t){var n=[];i(e,function(e,i){if(i.length<2){return}var r=t.filter(function(t){return t.getFileType()===e});r.forEach(function(e,t){if(i.indexOf(e.getId())>-1&&t<r.length-1){var s=r[t+1];var a=new Date(e.getCreation());var o=new Date(s.getCreation());if(s&&a>=o){var c=a.getTime()+1;s.setCreation(new Date(c).toISOString());var l=f.createFlexKey(s.getId());n.push({key:l,value:s})}}})});return n}function b(e,t){const i=[];if(e){Object.values(e).forEach(function(e){e.forEach(function(e){const n=f.createFlexKey(e);t.forEach(function(r){if(r.fileType!=="version"&&r.fileName===e){const e=t.find(e=>e.fileType==="version"&&e.id===r.version);if(e===undefined||e.isDraft){i.push({key:n,value:"delete"})}else{const e={...r};e.fileName+="_hide";delete e.content;i.push({key:`${n}_hide`,value:e})}}})})})}return i}var O=n({},o,{storage:undefined,layers:["ALL"],async loadFlexData(e){const t=await u({storage:this.storage,reference:e.reference});const i=await this.versions.getVersionChain.call(this,e,e.version);var n=[];let r=t.filter(function(e){if(e.version===undefined||i.includes(e.version)){if(e.fileName!==undefined&&e.fileName.endsWith("_hide")){n.push(e.fileName.replace("_hide",""));return false}return true}return false});if(n.length){r=r.filter(e=>e.fileName===undefined||!n.includes(e.fileName))}const s=c.sortFlexObjects(r);const a=c.getGroupedFlexObjects(s);const o=c.filterAndSortResponses(a);if(o.length){o[0].cacheKey=v(s)}return o},async write(e){const t=await this.loadFeatures();let i;if(t.isVersioningEnabled&&e.layer===r.CUSTOMER){e.reference=e.flexObjects[0]?.reference;i=await this.versions.getDraftId.call(this,e)}let n=0;const s=[];for(const t of e.flexObjects){if(i){t.version=i}const e=f.createFlexObjectKey(t);const r=h(t,++n);const a=this.storage._itemsStoredAsObjects?r:JSON.stringify(r);await this.storage.setItem(e,a);s.push(r)}return{response:s}},async update(e){var t=e.flexObject;if(l.isVersioningEnabled&&e.layer===r.CUSTOMER){e.reference=t.reference;const i=await this.versions.load.call(this,e);const n=i.find(e=>e.isDraft)?.id;if(n){t.version=n}}var i=f.createFlexObjectKey(e.flexObject);var n=this.storage._itemsStoredAsObjects?t:JSON.stringify(t);var s=this.storage.setItem(i,n);return Promise.resolve(s)},reset(e){return f.forEachObjectInStorage({storage:this.storage,reference:e.reference,layer:e.layer},function(t){if(d(e,t.changeDefinition)){return Promise.resolve(this.storage.removeItem(t.key)).then(function(){return{fileName:t.changeDefinition?.fileName||t.changeDefinition?.id}})}}.bind(this)).then(function(e){return{response:e.filter(function(e){return!!e})}})},remove(e){var t=f.createFlexObjectKey(e.flexObject);this.storage.removeItem(t);var i=this.storage.removeItem(t);return Promise.resolve(i)},loadFeatures(){return Promise.resolve(l)},loadVariantsAuthors(){return Promise.reject("loadVariantsAuthors is not implemented")},getFlexInfo(e){e.storage=this.storage;return f.getAllFlexObjects(e).then(function(e){return{isResetEnabled:e.length>0}})},async condense(e){var i=e.flexObjects;var n=[];n=n.concat(m(i.create,e));n=n.concat(y(i.update,e.condensedChanges));n=n.concat(p(i.reorder,e.condensedChanges));if(i.delete){const t=await u({storage:this.storage,reference:e.reference});n=n.concat(b(i.delete,t))}n=t(n,"key");var s=[];var a=[];const o=await this.loadFeatures();let c;if(o.isVersioningEnabled&&e.layer===r.CUSTOMER){c=await this.versions.getDraftId.call(this,e,n)}n.forEach(function(e){if(e.value==="delete"){s.push(this.storage.removeItem(e.key))}else{const i=e.key.endsWith("_hide")?e.value:e.value.convertToFileContent();if(c){i.version=c}if(!e.key.endsWith("_hide")){a.push(i)}var t=this.storage._itemsStoredAsObjects?i:JSON.stringify(i);s.push(this.storage.setItem(e.key,t))}}.bind(this));if(o.isVersioningEnabled&&e.layer===r.CUSTOMER&&i.delete&&Object.keys(i.delete).length!==0){const t=await this.versions.load.call(this,e);if(t.length){const n=t.find(e=>e.isDraft);Object.values(i.delete).forEach(function(e){e.forEach(function(e){n.filenames=n.filenames.filter(function(t){return t!==e})})});if(!n.filenames.length){await this.versions.discardDraft.call(this,e)}}}return Promise.all(s).then(function(){return Promise.resolve({response:a})})},versions:{async getDraftId(e,t){let i=[];if(e.condensedChanges){i=e.condensedChanges.map(e=>e.sId)}else{i=e.flexObjects.map(e=>e.fileName)}if(t){t.forEach(function(e){if(e.key.endsWith("_hide")){i.push(e.value.fileName)}})}const n=await this.versions.load.call(this,e);let o=n.find(e=>e.isDraft);if(o&&e.parentVersion===a.Number.Draft){if(e.condensedChanges){o.filenames=[]}o.filenames=i.concat(o.filenames)}else{if(o&&e.parentVersion!==a.Number.Draft){await this.versions.discardDraft.call(this,e)}o={version:a.Number.Draft,id:s.createDefaultFileName("version"),isDraft:true,activatedAt:"",activatedBy:"",fileType:"version",layer:r.CUSTOMER,title:"",reference:e.reference,filenames:i};if(e.parentVersion!==a.Number.Original){o.parentVersion=e.parentVersion}}const c=f.createFlexKey(`${o.id}`);const l=this.storage._itemsStoredAsObjects?o:JSON.stringify(o);await this.storage.setItem(c,l);return o.id},async getVersionChain(e,t){const i=[];const n=(e,t)=>e===t.version;const r=await this.versions.load.call(this,e);t||=r.find(e=>!e.isDraft)?.id;while(t&&t!==a.Number.Original){const e=r.find(n.bind(undefined,t));i.push(e.id);t=e.parentVersion}return i},async load(e){const t=await u({storage:this.storage,reference:e.reference});return t.filter(e=>e.fileType==="version").sort((e,t)=>{if(e.isDraft){return-1}if(t.isDraft){return 1}return e.activatedAt<t.activatedAt?1:-1})},async activate(e){const t=await this.loadFeatures();const i=await this.versions.load.call(this,e);var n=i.find(t=>t.version===e.version);if(n){if(!n.isDraft){n.id=s.createDefaultFileName("version");n.parentVersion=e.version}}else{const t=s.createDefaultFileName("version");n={version:t,id:t,fileType:"version",layer:r.CUSTOMER,reference:e.reference}}if(e.version!==a.Number.Draft){const t=i.find(e=>e.isDraft);if(t){await this.versions.discardDraft.call(this,e)}}const o=f.createFlexKey(n.id);n.title=e.title;n.activatedAt=new Date(Date.now()).toISOString();n.activatedBy=t.logonUser;n.isDraft=false;n.version=n.id;delete n.filenames;const c=this.storage._itemsStoredAsObjects?n:JSON.stringify(n);this.storage.setItem(o,c);return n},async discardDraft(e){e.storage=this.storage;const t=await this.versions.load.call(this,e);const i=t.find(e=>e.isDraft)?.id;if(!i){return Promise.reject("no version to discard")}const n=await u(e);const r=n.filter(e=>e.version===i);const s=t.find(e=>e.id===i);r.push(s);const a=r.map(e=>{var t=f.createFlexKey(e.fileName||e.id);return this.storage.removeItem(t)});await Promise.all(a)}}});return O});
//# sourceMappingURL=ObjectStorageConnector.js.map