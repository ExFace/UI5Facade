/*!
 * OpenUI5
 * (c) Copyright 2026 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/core/Element","sap/ui/core/Lib","sap/ui/fl/apply/_internal/appVariant/DescriptorChangeTypes","sap/ui/fl/apply/_internal/changeHandlers/ChangeHandlerStorage","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/flexObjects/FlexObjectFactory","sap/ui/fl/apply/_internal/flexObjects/States","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/FlexObjectState","sap/ui/fl/initial/_internal/ManifestUtils","sap/ui/fl/descriptorRelated/api/DescriptorChangeFactory","sap/ui/fl/write/_internal/appVariant/AppVariantInlineChangeFactory","sap/ui/fl/write/_internal/controlVariants/ControlVariantWriteUtils","sap/ui/fl/write/_internal/flexState/FlexObjectManager","sap/ui/fl/write/api/ContextBasedAdaptationsAPI","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/Utils","sap/ui/fl/write/_internal/init"],function(e,t,n,a,r,o,i,c,p,l,s,g,f,h,u,d,C,m,y,S,D,v,F){"use strict";var x={};function T(e){let n;if(e.changeSpecificData.layer){n=e.changeSpecificData.layer;delete e.changeSpecificData.layer}const a={changeType:e.changeSpecificData.changeType,content:e.changeSpecificData.content};if(e.changeSpecificData.texts){a.texts=e.changeSpecificData.texts}if(e.changeSpecificData.support){a.support={compositeCommand:e.changeSpecificData.support.compositeCommand||""}}if(e.changeSpecificData.adaptationId){a.adaptationId=e.changeSpecificData.adaptationId}return m.createDescriptorInlineChange(a).then(t=>(new C).createNew(e.changeSpecificData.reference,t,n,e.appComponent,e.generator)).catch(e=>{t.error("the change could not be created.",e.message);throw e})}async function w(e){const t=await c.getAnnotationChangeHandler({changeType:e.changeSpecificData.changeType});const a=g.createAnnotationChange(e.changeSpecificData);t.completeChangeContent(a,e.changeSpecificData,{modifier:n,appComponent:e.appComponent});return a}function I(e){const a=g.createUIChange(e.changeSpecificData);return c.getChangeHandler(a.getChangeType(),e.controlType,e.selector,n,a.getLayer()).then(r=>{const o={...e.changeSpecificData};if(o.content){Object.keys(o.content).forEach(e=>{if(!o[e]){o[e]=o.content[e]}else{t.warning(`The property '${e}' is defined both in the change specific data and its content.`)}})}return r.completeChangeContent(a,o,{modifier:n,appComponent:e.appComponent,view:F.getViewForControl(e.selector)})}).then(()=>{a.setState(f.LifecycleState.NEW);return a})}x.create=function(e){const{changeSpecificData:t,selector:r}=e;if(t.changeType==="codeExt"){return g.createControllerExtensionChange(t)}e.appComponent=F.getAppComponentForSelector(r.view||r);if(r?.appId||d.getFlexReferenceForControl(e.appComponent)){t.reference=r?.appId||d.getFlexReferenceForControl(e.appComponent)}const o={layer:t.layer,control:e.appComponent,reference:t.reference};if(D.hasAdaptationsModel(o)){t.adaptationId=D.getDisplayedAdaptationId(o)}if(i.getChangeTypes().includes(t.changeType)){return T(e)}if(e.changeSpecificData.changeType==="deactivateChanges"){return g.createFlexObject(e.changeSpecificData)}if(e.annotationChange){return w(e)}if(r instanceof a){return Promise.resolve(g.createUIChange(t))}if(r.name&&r.view){t.selector={name:r.name,viewSelector:n.getSelector(r.view.getId(),e.appComponent)};return I(e)}const c=r.id||r.getId();t.selector||={};Object.assign(t.selector,n.getSelector(c,e.appComponent));e.controlType=r.controlType||F.getControlType(r);return I(e)};x.apply=function(t){if(!(t.element instanceof r)){return Promise.reject("Please provide an Element")}t.appComponent=F.getAppComponentForSelector(t.element);t.modifier||=n;return p.applyChangeOnControl(t.change,t.element,e(t,["element","change"])).then(function(e){var a=u.getOpenDependentChangesForControl(n.getControlIdBySelector(t.change.getSelector(),t.appComponent),t.appComponent);if(a.length>0){return x.revert({change:t.change,element:t.element}).then(function(){var e=o.getResourceBundleFor("sap.ui.fl");var n=a.map(function(e){return e.getId()}).join(", ");throw Error(e.getText("MSG_DEPENDENT_CHANGE_ERROR",[t.change.getId(),n]))})}return e})};x.revert=function(e){var t=F.getAppComponentForSelector(e.element||{});var a=[];var r={modifier:n,appComponent:t};if(!Array.isArray(e.change)){return l.revertChangeOnControl(e.change,e.element,r)}var o=e.change.slice(0).reverse();return o.reduce(function(t,n){return t.then(function(){return l.revertChangeOnControl(n,e.element,r).then(function(e){a.unshift(e)})})},Promise.resolve()).then(function(){return a})};x.getChangeHandler=function(e){var t=e.controlType||e.modifier?.getControlType(e.element);return s.getChangeHandler({changeType:e.changeType,control:e.element,controlType:t,modifier:e.modifier,layer:e.layer,appDescriptorChange:e.appDescriptorChange,annotationChange:e.annotationChange})};x.deleteVariantsAndRelatedObjects=function(e){if(!e.variantManagementControl?.isA("sap.ui.fl.variants.VariantManagement")){throw new Error("Please provide a valid Variant Management control")}const a=e.variantManagementControl;const r=F.getAppComponentForControl(a);const o=n.getSelector(a,r).id;const i=d.getFlexReferenceForControl(r);let c=e.variants.filter(n=>{const a=h.getVariant({vmReference:o,reference:i,vReference:n});if(!a){t.warning(`Variant with ID '${n}' does not exist in the Variant Management control.`);return false}return a.layer===e.layer});if(!e.forceDelete){const t=v.getDraftFilenames({control:a,layer:e.layer});const n=u.getDirtyFlexObjects(i).map(e=>e.getId());c=c.filter(e=>t.includes(e)||n.includes(e))}return c.map(e=>y.deleteVariant(i,o,e)).flat()};x.restoreDeletedFlexObjects=function(e){S.restoreDeletedFlexObjects(e)};return x});
//# sourceMappingURL=ChangesWriteAPI.js.map